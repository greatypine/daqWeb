<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>基础数据模型</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <link rel="shortcut icon" type="image/x-icon" href="../icon.png" />
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=0.3, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.6 -->
  <link rel="stylesheet" href="../crm/bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../crm/bootstrap/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="../crm/bootstrap/css/ionicons.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../crm/dist/css/AdminLTE.min.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="../crm/dist/css/skins/_all-skins.min.css">
  <link rel="stylesheet" href="../crm/dist/css/tTurnover-head-scoll.css">
  <!--map style-->
  <link rel="stylesheet" href="../crm/dist/css/map-style.css">
  <link rel="stylesheet" href="../crm/dist/css/onoffset.css">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="IE 9/html5shiv.min.js"></script>
  <script src="IE 9/respond.min.js"></script>
  <![endif]-->
  <style>
    /* .logo-lg i{margin-right: 5px;}
    .logo-lg > ul > li:hover{border-bottom: 3px solid #46A3FF;-webkit-transition: all .2s ease-in-out;-o-transition: all .2s ease-in-out;transition: all .2s ease-in-out;}
    .logo-lg > ul > li:hover > a{color: #66B3FF; font-weight: bold;}
    .logo-lg > ul > li:hover i{color: #66B3FF;} */

    .col-lg-5 h5{margin-top: 20px;}
    /* #mapContainer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
     } */
     .crumbs a{padding: 5px 10px; background-color: #3c8dbc; color: #fff; margin-right: 10px; border-radius: 5px;}
    .crumbs .village_dis{padding: 5px 10px;background: none; color: #2d3e50; margin-right: 10px; border-radius: 5px;curosr: pointer}
    .table{border:1px solid #f4f4f4}
    .table tr td:nth-child(5),.table tr th:nth-child(5){border-left:1px solid #357ca5;}
    .r-container li{border-bottom: 1px solid #e4e4e4; margin-top: 20px; padding-bottom: 10px; color: #666; line-height: 24px;}
	.r-container p:nth-child(1){font-weight: bold;}
	.r-container p span:nth-child(1){display: inline-block; width: 80px; color: #333;}
    /* .table tr td{text-align:center;line-height:15px;} */
    

  </style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">



<header class="main-header">
    <nav class="navbar navbar-static-top">
      <div class="container">
					<div class="logo_img pull-left">
						<img src="../crm/dist/img/logo.png" height="30">
						<img src="../crm/dist/img/title.png" height="20">
					</div>
					<div class="pull-left">
						<div class="logo-lg">
							<ul class="no-margin">
								<li class="current"><em>基础数据模型</em></li>
							</ul>
						</div>
					</div>
      </div>
    </nav>
  </header>
  
  
  
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- <div class="container"> -->
      <!-- Main content -->
      <section class="content-header">
        <div class="col-lg-5" style="background-color: #fff;" id="divheight">
          <h4 class="text-light-blue"><strong>社区基础信息</strong></h4>
          <div><span class="text-muted" style="padding-bottom:10px;font-size:16px;">范围:</span><span id="showCoverage" class="text-yellow" style="padding-bottom:10px;font-size:16px;">--</span></div>
          <table class="table table-striped no-margin">
                <tbody id="manual_tbody">
                <tr>
                  <th></th>
                  <th>总数量</th>
                  <th>国安社区已覆盖数量</th>
                  <th class="text-aqua">服务覆盖率%</th>
                  <th>居民总户数</th>
                  <th>
                  	<font id="showattention" style="top:7px;right:75px;color:#ffcc00;font-size:16px;font-weight:normal;">!</font>
                  	居民数
                  	<font id="attention" style="font-size: 12px;white-space: nowrap;position: absolute;top:-3px;z-index: 1000;display:none;left:12px">（户数*3）</font>
                  </th>
                  <th>国安社区已消费居民数</th>
                  <th class="text-aqua">居民覆盖率%</th>
                </tr>
                <tr id="province">
                  <td>省</td>
                  <td id="provinceCount">1</td>
                  <td id="conProvinceCount">1</td>
                  <td class="text-aqua" id="serviceCoverage">100.00%</td>
                  <td id="residentsHouseCount">--</td>
                  <td id="residentsCount">--</td>
                  <td id="customerCount">--</td>
                  <td id="residentsCoverage">--</td>
                </tr>
                <tr id="city">
                  <td>市</th>
                  <td id="cityCount">1</td>
                  <td id="conCityCount">1</td>
                  <td class="text-aqua" id="cityserviceCoverage">100.00%</td>
                  <td id="cityResidentsHouseCount">--</td>
                  <td id="cityResidentsCount">--</td>
                  <td id="cityCustomerCount">--</td>
                  <td id="cityResidentsCoverage">--</td>
                </tr>
                <tr id="county">
                  <td>区</td>
                  <td id="countyCount">1</td>
                  <td id="conCountyCount">1</td>
                  <td class="text-aqua" id="countyServiceCoverage">100.00%</td>
                  <td id="countyResidentsHouseCount">--</td>
                  <td id="countyResidentsCount">--</td>
                  <td id="countyCustomerCount">--</td>
                  <td id="countyResidentsCoverage">--</td>
                </tr>
                <tr id="town">
                  <td>街道</td>
                  <td id="townCount">1</td>
                  <td id="conTownCount">1</td>
                  <td class="text-aqua" id="townServiceCoverage">100.00%</td>
                  <td id="townResidentsHouseCount">--</td>
                  <td id="townResidentsCount">--</td>
                  <td id="townCustomerCount">--</td>
                  <td id="townResidentsCoverage">--</td>
                </tr>
                <tr id="community">
                  <td>社区</td>
                  <td id="villageCount">1</td>
                  <td id="conVillageCount">1</td>
                  <td class="text-aqua" id="villageServiceCoverage">100.00%</td>
                  <td id="villageResidentsHouseCount">--</td>
                  <td id="villageResidentsCount">--</td>
                  <td id="villageCustomerCount">--</td>
                  <td id="villageResidentsCoverage">--</td>
                </tr>
                <tr id="village">
                  <td>小区</td>
                  <td id="tinyVillageCount">1</td>
                  <td id="conTinyVillageCount">1</td>
                  <td class="text-aqua" id="tinyVillageServiceCoverage">100.00%</td>
                  <td id="tinyVillageResidentsHouseCount">--</td>
                  <td id="tinyVillageResidentsCount">--</td>
                  <td id="tinyVillageCustomerCount">--</td>
                  <td id="tinyVillageResidentsCoverage">--</td>
                </tr>
                <tr id="building">
                  <td>楼房</td>
                  <td id="buildingCount">--</td>
                  <td id="conBuildingCount">--</td>
                  <td id="buildingServiceCoverage">--</td>
                  <td id="buildingResidentsHouseCount">--</td>
                  <td id="buildingResidentsCount">--</td>
                  <td id="buildingCustomerCount">--</td>
                  <td id="buildingResidentsCoverage">--</td>
                </tr>
                <tr id="house">
                  <td>房间数</td>
                  <td id="houseCount">--</td>
                  <td id="conHouseCount">--</td>
                  <td id="houseServiceCoverage">--</td>
                  <td id="houseResidentsHouseCount">--</td>
                  <td id="houseResidentsCount">--</td>
                  <td id="houseCustomerCount">--</td>
                  <td id="houseResidentsCoverage">--</td>
                </tr>
                </tbody>
              </table>
              <div class="r-container">
						<ol class="no-padding">
							<li>
								<p><span>小区名称：</span><span id="tiny_village_name">--</span></p>
								<p><span>小区地址：</span><span id ="tiny_village_address">--</span></p>
								<p><span>所属社区：</span><span id="village_name">--</span></p>
								<p><span>所属街道：</span><span id="town_name">--</span></p>
							</li>

						</ol>
			  </div>
        </div>
        <div class="col-lg-7">
          <div class="crumbs" style="display:none;margin-bottom:10px;">
          	<a class="namehide" href="javascript:goCountry()">全国</a>
          	<span class="namehide" style="color:#2d3e50">&nbsp;>&nbsp;</span>
          	<a href="javascript:gopro()" id="pro_country">--</a>
          	<span style="color:#2d3e50">&nbsp;>&nbsp;</span>
          	<a href="javascript:goStore()" id="pro_country_store">--</a> 
          	<span style="color:#2d3e50" id="pro_country_store_area_span">&nbsp;>&nbsp;</span>
          	<a href="javascript:goArea()" id="pro_country_store_area">--</a>
          	<span style="color:#2d3e50">&nbsp;>&nbsp;</span>
          	<a href="javascript:void()" class="village_dis" style="cursor:default" id="pro_country_store_area_village">--</a> 
          </div>
          <div id="mapHeight" style="width: 100%;height:auto;" >
           	<div id="mapContainer" style="background-color:rgba(0,0,0,0.5);width: 100%;height:100%;"></div>
          </div>
        </div>
      </section>

    <!-- </div> -->
  </div>
  <!-- /.content-wrapper -->


</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.0 -->
<script src="../crm/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script type="text/javascript" src="../scripts/bidLibjsjquery3.0.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="../crm/bootstrap/js/bootstrap.min.js"></script>
<!-- Morris.js charts -->
<script src="../crm/bootstrap/js/raphael-min.js"></script>
<script src="../crm/plugins/morris/morris.min.js"></script>
<!-- FastClick -->
<script src="../crm/plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="../crm/dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="../crm/dist/js/demo.js"></script>
<script type="text/javascript" src="../scripts/bidLibjsjquery3.0.js"></script>
<!-- page script -->
<script src="../crm/dist/js/jquery.dataStatistics.js"></script>
<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.2&key=f52a1bb11408e8a46dc884b2aaa44edc&plugin=AMap.PolyEditor"></script>

<script type="text/javascript">
  autodivheight();
  function autodivheight(){ //函数：获取尺寸
    //获取浏览器窗口高度
    var winHeight=0;
    if (window.innerHeight)
      winHeight = window.innerHeight;
    else if ((document.body) && (document.body.clientHeight))
      winHeight = document.body.clientHeight;
    //通过深入Document内部对body进行检测，获取浏览器窗口高度
    if (document.documentElement && document.documentElement.clientHeight)
      winHeight = document.documentElement.clientHeight;
    //DIV高度为浏览器窗口的高度
    document.getElementById("mapHeight").style.height= winHeight - 129 +"px";
    document.getElementById("divheight").style.height= winHeight - 100 +"px";
  }
  window.onresize=autodivheight; //浏览器窗口发生变化时同时变化DIV高度
</script>
<!-- 引入 ECharts 文件 -->
<script src="../crm/dist/js/echarts.common.min.js"></script>
<script src="../crm/dist/js/china.js"></script>
<script>
var pageStatusInfo = {};
//初始化地图对象，加载地图
var map = new AMap.Map("mapContainer", {
	resizeEnable : true,
	doubleClickZoom : false,
	zooms:[10,18],
});

$(function(){
	//获得参数
	pageStatusInfo = getReauestParameters();
	//显示页面统计数据
	showPageContent(pageStatusInfo);
	$(".crumbs").show();
	if(pageStatusInfo.iscity == "city"){
		$(".namehide").hide();
	}
	$("#pro_country").html(pageStatusInfo.cityName);
	//初始化门店名称及片区及小区名称
	initStoreAndAreaAndVillageName(pageStatusInfo);
	$("#showattention").on("mouseover",function(event){
  		$("#attention").show();
  	});
  	$("#showattention").on("mouseout",function(event){
  		$("#attention").hide();
  	});
});

//获取请求参数
var getReauestParameters = function () {

var cityId = (decode64(getUrlParamByKey("c")) == 'null'||decode64(getUrlParamByKey("c")) == null) ? '' : decode64(getUrlParamByKey("c"));

var storeId = (decode64(getUrlParamByKey("s")) == 'null'||decode64(getUrlParamByKey("s")) == null) ? '' : decode64(getUrlParamByKey("s"));
// 省份ID
var provinceId = (decode64(getUrlParamByKey("p"))=='null'||decode64(getUrlParamByKey("p"))==null) ? '' : decode64(getUrlParamByKey("p")).trim();
// 城市名称
var cityName = (decode64(getUrlParamByKey("cn")) == 'null'||decode64(getUrlParamByKey("cn")) == null) ? '' : decode64(getUrlParamByKey("cn"));
// 缩放级别
var provinceName = (decode64(getUrlParamByKey("pn")) == 'null'||decode64(getUrlParamByKey("pn")) == null) ? '' : decode64(getUrlParamByKey("pn"));
var areaNo = (decode64(getUrlParamByKey("an")) == 'null'||decode64(getUrlParamByKey("an")) == null) ? '' : decode64(getUrlParamByKey("an"));

var code = (decode64(getUrlParamByKey("cd")) == 'null'||decode64(getUrlParamByKey("cd")) == null) ? '' : decode64(getUrlParamByKey("cd"));
var iscity = (decode64(getUrlParamByKey("iscity")) == 'null'||decode64(getUrlParamByKey("iscity")) == null) ? '' : decode64(getUrlParamByKey("iscity"));

var rtnData = {
    "cityId": cityId,
    "provinceId": provinceId,
    "cityName": cityName,
    "provinceName": provinceName,
    "storeId":storeId,
    "code":code,
    "areaNo":areaNo,
    "iscity":iscity
};
return rtnData; 
};

var showPageContent = function(pageStatusInfo){
	getStorePositionAndServiceArea(pageStatusInfo);
	showData(pageStatusInfo);
}

var showData = function(pageStatusInfo){
	doManager("MapBasicDataManager", "getVillageBasicData", pageStatusInfo.code, function (data, textStatus, XMLHttpRequest) {
        if (data.result) {
            var jsonData = JSON.parse(data.data);
            if (jsonData.code == 200) {
            	debugger;
            	var buildingCount = jsonData.buildingCount;
            	var houseCount = jsonData.houseCount;
            	var residentsHouseCount = jsonData.residentsHouseCount;
            	var customerCount = jsonData.customerCount;
            	//楼房信息
            	$("#buildingCount").html(buildingCount);
            	$("#conBuildingCount").html(buildingCount);
            	$("#buildingServiceCoverage").html("100.00%");
            	$("#buildingServiceCoverage").addClass("text-aqua");
            	//房间数信息
            	$("#houseCount").html(houseCount);
            	$("#conHouseCount").html(houseCount);
            	$("#houseServiceCoverage").html("100.00%");
            	$("#houseServiceCoverage").addClass("text-aqua");
            	//用户信息
            	$("#tinyVillageResidentsHouseCount").html(residentsHouseCount);
            	var residentsCount = residentsHouseCount*3;
               	$("#tinyVillageResidentsCount").html(residentsCount);
            	$("#tinyVillageCustomerCount").html(customerCount);
            	var peopleCount = residentsCount == 0 ? 0:(customerCount/residentsCount)*100;
            	var residentsCoverage = peopleCount.toFixed(2);
            	$("#tinyVillageResidentsCoverage").html(residentsCoverage+"%");
            	$("#tinyVillageResidentsCoverage").addClass("text-aqua");
            }
        }
    }, false);
	doManager("TinyVillageManager", "queryTinyVillageInfoByVillagecode",pageStatusInfo.code, function(data,textStatus, XMLHttpRequest) {
		if (data.result) {
			var tinyVillage = JSON.parse(data.data).data;
			var tiny_village_name = tinyVillage.tiny_village_name;
			var tiny_village_address = tinyVillage.tiny_village_address;
			var dellable = tinyVillage.dellable;
			var tiny_village_id = tinyVillage.tiny_village_id;
			var village_name = tinyVillage.village_name;
			var town_name = tinyVillage.town_name;
			if(dellable == 0 || dellable == null){
				$("#tiny_village_name").html(tiny_village_name);
			}else{
				$("#tiny_village_name").html(tiny_village_name+"(待删除)");
			}
			$("#tiny_village_address").html(tiny_village_address);
			$("#village_name").html(village_name);
			$("#town_name").html(town_name);
		}
	}, false);
}

var initStoreAndAreaAndVillageName = function (pageStatusInfo){
	//var storeId = pageStatusInfo.storeId;
	//var storeName = pageStatusInfo.storeName;
	doManager("StoreManager", "findStore",[pageStatusInfo.storeId],
			function(data, textStatus, XMLHttpRequest) {
				if (data.result) {
					var store = JSON.parse(data.data);
					$("#pro_country_store").html(store.name);
					//currentStore = store;
				}
		},false);
	if(pageStatusInfo.areaNo.trim() != ""){
		doManager("AreaManager", "queryAreaByAreaNo",[pageStatusInfo.areaNo],
				function(data, textStatus, XMLHttpRequest) {
					if (data.result) {
						var area = JSON.parse(data.data);
						$("#pro_country_store_area").html(area.name);
						//currentArea = store;
					}
		},false);
	}else{
		$("#pro_country_store_area").hide();
		$("#pro_country_store_area_span").hide();
	}
	
	doManager("TinyVillageCodeManager", "findTinyVillageByCode",[pageStatusInfo.code],
			function(data, textStatus, XMLHttpRequest) {
				if (data.result) {
					var tiny_village = JSON.parse(data.data);
					$("#pro_country_store_area_village").html(tiny_village.tiny_village_name);
					$("#showCoverage").html(tiny_village.tiny_village_name+" 小区");
					//currentArea = store;
				}
		},false);
}

function getStorePositionAndServiceArea(pageStatusInfo){
	  doManager("areaManager", "getStoreServiceAreaAndPosition", [pageStatusInfo.storeId], function(
				data, textStatus, XMLHttpRequest) {
			if (data.result) {
				var resultJson = JSON.parse(data.data);
				if(resultJson.code == 200){
					var serviceArea = resultJson.serviceArea;
					var servicePolygon = new AMap.Polygon({
	        	        path: serviceArea,//设置多边形边界路径
	        	        strokeColor: "#F00", //线颜色
	        	        strokeOpacity: 0.9, //线透明度
	        	        strokeWeight: 2,    //线宽
	        	        fillColor: "#00DD00", //填充色
	        	        fillOpacity: 0//填充透明度
	        	    });
					servicePolygon.setMap(map);
					
				}
			}
		},false);
doManager("mongoDBManager", "selectCoordinatesOfCode",[pageStatusInfo.code], function(data, textStatus,XMLHttpRequest) {
      if(data.result){
      	var resultJson= JSON.parse(data.data);
      	var coordinatesArray = resultJson.data;
      	for(var i = 0; i < coordinatesArray.length; i++){
      		var coordinates = coordinatesArray[i];
      		var villagePolygon = new AMap.Polygon({
      	        path: coordinates.coordinates,//设置多边形边界路径
      	        strokeColor: "#f99200", //线颜色
      	        strokeOpacity: 0.9, //线透明度
      	        strokeWeight: 2,    //线宽
      	        fillColor: "#00DD00", //填充色
      	        fillOpacity: 0.1,//填充透明度
      	        extData:{"code":coordinates.code,"name":coordinates.name}
      	    });
      		villagePolygon.setMap(map);
      		map.setCenter(villagePolygon.getBounds().getCenter());
      		map.setZoom(18);
      	}
      }else{
          $$.showMessage("系统信息", "数据加载异常！");
      }},false);
}

var goCountry = function(){
	window.open("china_city_dataview.html","iframe");
}

var gopro = function(){
	var provinceId = pageStatusInfo.provinceId;
	var provinceName = pageStatusInfo.provinceName;
	var cityId = pageStatusInfo.cityId;
	var cityName = pageStatusInfo.cityName;
	var iscity = pageStatusInfo.iscity;
	var url="china_city_dataview.html?p="+encode64(provinceId)+"&c="+encode64(cityId)+"&cn="+encode64(cityName)+"&pn="+encode64(provinceName)+"&iscity="+encode64(iscity);
	window.open(url,"iframe");
}

var goStore = function(){
	var provinceId = pageStatusInfo.provinceId;
	var provinceName = pageStatusInfo.provinceName;
	var cityId = pageStatusInfo.cityId;
	var cityName = pageStatusInfo.cityName;
	var storeId = pageStatusInfo.storeId;
	var iscity = pageStatusInfo.iscity;
	var url="store_dataview.html?p="+encode64(provinceId)+"&c="+encode64(cityId)+"&cn="+encode64(cityName)+"&pn="+encode64(provinceName)+"&s="+encode64(storeId)+"&iscity="+encode64(iscity);
	window.open(url,"iframe");
}

var goArea = function(){
	var provinceId = pageStatusInfo.provinceId;
	var provinceName = pageStatusInfo.provinceName;
	var cityId = pageStatusInfo.cityId;
	var cityName = pageStatusInfo.cityName;
	var storeId = pageStatusInfo.storeId;
	var areaNo = pageStatusInfo.areaNo;
	var iscity = pageStatusInfo.iscity;
	var url="tiny_area_dataview.html?p="+encode64(provinceId)+"&c="+encode64(cityId)+"&cn="+encode64(cityName)+"&pn="+encode64(provinceName)+"&s="+encode64(storeId)+"&an="+encode64(areaNo)+"&iscity="+encode64(iscity);
	window.open(url,"iframe");
}
</script>

</body>
</html>