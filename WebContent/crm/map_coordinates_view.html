<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>社区地图</title>
    <link rel="shortcut icon" type="image/x-icon" href="../icon.png" />
    <link rel="stylesheet" href="https://cache.amap.com/lbs/static/main1119.css"/>
    
    <link rel="stylesheet" href="../crm/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../crm/bootstrap/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="../crm/bootstrap/css/ionicons.min.css">
    <link rel="stylesheet" href="../data_access/dist/css/skins/_all-skins.min.css">
	<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.1&key=f52a1bb11408e8a46dc884b2aaa44edc&plugin=AMap.PolyEditor"></script>
    <style type="text/css">
        *{margin: 0; padding: 0;}
        ul,li{list-style: none;} 
        body {
            margin: 0;
            height: 100%;
            width: 100%;
            position: absolute;
            font-size: 12px;;
        }

        #mapContainer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        .menu{position: absolute; top: 50px;  left: 20px; width: 350px;}
        .sidebar-form{position: fixed; width: 350px; height: 43px; line-height: 40px; background-color: #fff; box-shadow: 1px 2px 1px rgba(0,0,0,.15); border: 0!important;}
        .menu_list{margin: 55px 0 0 0; width: 350px; background-color: #fff; overflow: hidden; padding-top: 15px!important; box-shadow: 1px 2px 1px rgba(0,0,0,.15);-webkit-transition: all .3s ease-in-out;-o-transition: all .3s ease-in-out;transition: all .3s ease-in-out}
        .menu_list ul{overflow-y: auto;}
        .menu_list ul::-webkit-scrollbar{width: 8px; background-color: #fff;}
        .menu_list ul::-webkit-scrollbar-thumb{background-color: #adadad; border-radius: 5px;}
        .menu_list ul::-webkit-scrollbar-track{background-color: #fff;}
        .menu_list li{width: 316px; line-height: 22px; padding: 5px 8px 15px 8px; margin: 0 10px 0 15px; border-bottom: 1px solid #eaeaea;}
        .menu_list li:nth-last-child(1){border: none;}
        .menu_list li p:nth-child(2){padding-bottom: 7px; font-size: 14px; color: #333;}
        p{margin: 0;}
        .menu_list li a{color: #999; display: inline-block; width: 100%; text-decoration: none; padding-top: 5px;}
        .menu_list li:hover,.menu_list li:visited,.menu_mark{background-color: rgba(0,0,0,0.05);}
        .btn{padding: 0 12px; font-size: 20px; color: #808499;}
        .form-control{font-size: 16px; padding: 0 8px!important;}
        .result_hide{padding: 15px 0 10px 0;margin: 55px 0 0 0; width: 349px; background-color: #fff; color: #3385ff; text-align: center; font-size: 14px; padding: 10px 0 10px 0; -webkit-transition: all .3s ease-in-out;-o-transition: all .3s ease-in-out;transition: all .3s ease-in-out}
    	.checkboxFive {width: 20px;position: relative; margin: 20px 20px 20px 0; padding-left: 10px;}
		.checkboxFive label {
		    width: 20px;
		    height: 20px;
		    cursor: pointer;
		    position: absolute;
		    top: -3px;
		    left: 0;
		    background: -moz-linear-gradient(top, #f4f4f4 0%, #f9f8f8 100%);
		    background: -webkit-linear-gradient(top, #f4f4f4 0%, #f9f8f8 100%);
		    background: linear-gradient(to bottom, #f4f4f4 0%, #f9f8f8 100%);
		    -moz-border-radius: 4px;
		    -webkit-border-radius: 4px;
		    border-radius: 4px;
		    -moz-box-shadow: inset 0px 1px 1px rgba(0, 0, 0, 0.5), 0px 1px 0px rgba(255, 255, 255, 0.4);
		    -webkit-box-shadow: inset 0px 1px 1px rgba(0, 0, 0, 0.5), 0px 1px 0px rgba(255, 255, 255, 0.4);
		    box-shadow: inset 0px 1px 1px rgba(0, 0, 0, 0.5), 0px 1px 0px rgba(255, 255, 255, 0.4);
		}
		.checkboxFive label:after {
		    content: '';
		    width: 12px;
		    height: 7px;
		    position: absolute;
		    top: 5px;
		    left: 4px;
		    border: 3px solid #5a5a5a;
		    border-top: none;
		    border-right: none;
		    background: transparent;
		    filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=0);
		    opacity: 0;
		    -moz-transform: rotate(-45deg);
		    -ms-transform: rotate(-45deg);
		    -webkit-transform: rotate(-45deg);
		    transform: rotate(-45deg);
		}
		.checkboxFive label:hover::after {
		    filter: progid:DXImageTransform.Microsoft.Alpha(Opacity=30);
		    opacity: 0.3;
		}
		.checkboxFive input[type=checkbox] {
		    visibility: hidden;
		}
		.checkboxFive input[type=checkbox]:checked + label:after {
		    filter: progid:DXImageTransform.Microsoft.Alpha(enabled=false);
		    opacity: 1;
		}
		.amap-marker .marker-route {
            position: absolute;
            padding: 5px 10px;
            color: #e90000;
            background: #ff9600;
            cursor: pointer;
          white-space:nowrap;
          position: relative;
          color: #fff;
          border-radius: 3px;
          font-size:14px;
        }
     .marker-route:after {
       	content:'';
        position: absolute;
       	width: 0;
	    height: 0;
	    border-left: 5px solid transparent;
	    border-right: 5px solid transparent;
	    border-top: 6px solid #ff9600;
      	bottom: -6px;
       	left:50%;
       	margin-left:-5px;
      }
    #process_div{ 
		background-color:#292a2b; 
		display:inline; 
		z-index:100000;  
		left:0px; 
		opacity:0.3; top:0; left:0;height:100%; width:100%; z-index:999; position:fixed; _position:absolute; _left: expression_r(documentElement.scrollLeft + documentElement.clientWidth - this.offsetWidth); _top: expression_r(documentElement.scrollTop + documentElement.clientHeight - this.offsetHeight);
		filter:Alpha(Opacity=30); 
		opacity: 0.3; 
	} 
	
	#process_div_pic{
		position:fixed;
		top:50%;
		left:50%; 
		z-index:100000000; 
		margin:-16px 0 0 -50px; 
		width:100px; 
		height:32px;
		color: #fff;
	}
     </style>  
</head>
<body class="skin-blue">
<div id="process_div" ></div>
<div id="process_div_pic" ><img style="width:50px;height: 50px;" src="dist/img/376884043677306248.png"><i class="fa fa-refresh fa-spin"></i></div>
<div id="mapContainer" style="background-color:rgba(0,0,0,0.5)"></div>
<div class='button-group' style="background-color: #fff;box-shadow: 1px 2px 1px rgba(0,0,0,.15);border-radius: 2px; padding: 7px 10px 10px 10px;">
    <span class="checkboxFive">
        <input type='checkbox' id="storeNameClick" onclick='storeNameClick()' checked value='storeName'>门店名称显示
        <label for="storeNameClick"></label>
    </span>
    <span class="checkboxFive">
        <input type='checkbox' id="serviceClick" onclick='operatedCoverage()' checked name='bg'>运营覆盖范围
        <label for="serviceClick"></label>
    </span>
    <span class="checkboxFive">
        <input type='checkbox' id="landminingClick" onclick='landMiningAreaCoverage(id)' checked value='landmining'>地采覆盖范围
        <label for="landminingClick"></label>
    </span>
    <span class="checkboxFive">
        <input type='checkbox' id="areaClick" onclick='landMiningAreaCoverage(id)' value='area'>混片覆盖范围
        <label for="areaClick"></label>
    </span>
</div>
<!--左侧列表-->
<!-- <div class="menu">
    <div class="sidebar-form">
        <div class="input-group">
            <input id="search" type="text" name="q"   class="form-control" placeholder="搜索">
            <span class="input-group-btn">
                <button onClick="cleanSearch()" class="btn btn-flat"><i class="fa fa-remove" style="color: #bbc0c2; font-weight: normal;"></i></button>
              </span>
        </div>
    </div>
    <div class="menu_list">
        <ul id="namelist">
             <li>
                <a href="#"><p><span>1.</span>呼家楼小区</p>
                <p>朝阳区呼家楼街道呼家楼小区朝阳区呼家楼街道呼家楼小区朝阳区呼家楼街道呼家楼小区</p></a>
            </li> 
        </ul>
    </div>
    <div class="result_hide" style="display: none;">展开搜索结果</div>
</div> -->
<!--左侧列表-->

<script src="plugins/jQuery/jQuery-2.2.0.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="bootstrap/js/bootstrap.min.js"></script>
<!-- Morris.js charts -->
<script src="bootstrap/js/raphael-min.js"></script>
<script src="plugins/morris/morris.min.js"></script>
<!-- FastClick -->
<script src="plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>

<script type="text/javascript" src="../scripts/bidLibjsjquery3.0.js"></script>
<script type="text/javascript">
   /*    autodivheight();
    function autodivheight(){ //函数：获取尺寸
        //获取浏览器窗口高度
        var winHeight=0;
        if (window.innerHeight)
            winHeight = window.innerHeight;
        else if ((document.body) && (document.body.clientHeight))
            winHeight = document.body.clientHeight;
        //通过深入Document内部对body进行检测，获取浏览器窗口高度
        if (document.documentElement && document.documentElement.clientHeight)
            winHeight = document.documentElement.clientHeight;
        //DIV高度为浏览器窗口的高度
        //document.getElementById("test").style.height= winHeight +"px";
        //DIV高度为浏览器窗口高度的一半
        document.getElementById("namelist").style.maxHeight= winHeight - 200 +"px";
    }
    window.onresize=autodivheight; //浏览器窗口发生变化时同时变化DIV高度  */
</script>
<script type="text/javascript">
var cityId = decode64(getUrlParamByKey("c"));     /**城市ID*/
var cityName = decode64(getUrlParamByKey("cn")); /**城市名称*/
var employeeId = decode64(getUrlParamByKey("e")); /**员工编号*/
var target = decode64(getUrlParamByKey("t"));   /**1.城市；2.门店**/
var serviceArray = [];/**门店服务范围数组*/
var coordinatesArray = [];/**小区数组*/
var divideAreaCoordinatesArray=[];/**地采除混片坐标数组*/
var areaCoordinatesArray=[];/**混片范围坐标数组*/
var serviceCoordinatesArray = [];/**服务范围坐标数组*/
var vallageCoordinatesArray = [];/**小区坐标数组*/


//初始化地图对象，加载地图
var map = new AMap.Map("mapContainer", {
    resizeEnable : true,
    //zoom : 14,
    doubleClickZoom : false
});
map.setCity(cityName);

map.plugin(["AMap.ToolBar"],function(){
    //加载工具条
    var toolBaropt = {
        offset :new AMap.Pixel(30,100),//相对于地图容器左上角的偏移量，正数代表向右下偏移。默认为AMap.Pixel(10,10)
        position : 'RT',//工具放置位置RT:右上角;
        ruler : true,//标尺键盘是否可见，默认为true
        noIpLocate : false,//定位失败后，是否开启IP定位，默认为false
        locate : true,//是否显示定位按钮，默认为false
        liteStyle : false,//是否使用精简模式，默认为false
        direction : true,//方向键盘是否可见，默认为true
        autoPosition : false,//是否自动定位，即地图初始化加载完成后，是否自动定位的用户所在地，在支持HTML5的浏览器中有效，默认为false
        useNative : false
    }
    var tool = new AMap.ToolBar(toolBaropt);
    map.addControl(tool);
});


//画服务范围多边形
var servicePolygon = servicePolygon = new AMap.Polygon({
       strokeColor: "#5c69cc", //线颜色
       strokeOpacity: 0.9, //线透明度
       strokeWeight: 2,    //线宽
       fillColor: "#046ad3", //填充色
       fillOpacity: 0.1//填充透明度
 });
servicePolygon.setMap(map);
//所有小区坐标的多边形
var vallagePolygon = new AMap.Polygon({
     //path: villageCoordinates,//设置多边形边界路径
      strokeColor: "#e513e5", //线颜色
      strokeOpacity: 0.9, //线透明度
      strokeWeight: 1,    //线宽
      fillColor: "#FF33FF", //填充色
      fillOpacity: 0.1,//填充透明度
     //	extData:{"code":code}
});
vallagePolygon.setMap(map);
//混片多边形
var areaPolygon = new AMap.Polygon({
    //path: villageCoordinates,//设置多边形边界路径
    strokeColor: "#e513e5", //线颜色
    strokeOpacity: 0.9, //线透明度
    strokeWeight: 1,    //线宽
    fillColor: "#FF33FF", //填充色
    fillOpacity: 0.6,//填充透明度
   //	extData:{"code":code}
});
areaPolygon.setMap(map);

/* //混片多边形
var test1 = new AMap.Polygon({
    //path: villageCoordinates,//设置多边形边界路径
    strokeColor: "#e513e5", //线颜色
    strokeOpacity: 0.9, //线透明度
    strokeWeight: 1,    //线宽
    fillColor: "#FF33FF", //填充色
    fillOpacity: 0.6,//填充透明度
   //	extData:{"code":code}
});
test1.setMap(map); */



$(function(){
	$("#process_div").show();
	$("#process_div_pic").show();
     doManager("TinyAreaManager", "getTinyVillageCoordAndServiceArea",[cityId], function(data, textStatus,XMLHttpRequest) {
        if(data.result){
                jsonData = JSON.parse(data.data);
                //服务范围展示
                var serviceArea = jsonData.serviceArea;
                if(serviceArea.code == 200){
                	//服务范围数组
                	serviceArray = serviceArea.data;
                	if(serviceArray!=null && serviceArray.length>0){
                		var storeMarker;
                    	for(var i=0;i<serviceArray.length;i++){
                    		var polygonArray = serviceArray[i];
                    		var serviceCoordinates=polygonArray.vertex;
                    		var storeNo = polygonArray.storeNo;
                    		var storeName = polygonArray.storeName;
                    		var strLength = -((storeName.length*14+20)/2);
                    		if(storeNo != "0021Y0020"){
                    			var position = polygonArray.position;
                        		serviceCoordinatesArray.push(serviceCoordinates);
                    		}
                    		//注意path是否有值
                       		polygonArray.polygonMap = servicePolygon;
                    		if(position != null && position.length>0){
                    			storeMarker = new AMap.Marker({ //添加自定义点标记
                    		        map: map,
                    		        position: position, //基点位置
                    		        offset: new AMap.Pixel(strLength, -36), //相对于基点的偏移位置
                    		       // draggable: true,  //是否可拖动
                    		        content: '<div class="marker-route marker-marker-bus-from">'+storeName+'</div>'   //自定义点标记覆盖物内容
                    		    }); 
                    			polygonArray["marker"] = storeMarker;
                    			storeMarker.on("click",function(e){
                    				map.setCenter(e.target.getPosition());
                    				map.setZoom(14);
                    			});
                    		}
                    	}
                    	servicePolygon.setPath(serviceCoordinatesArray);
                	}
                }
                //坐标范围展示
                 var coordinatesArea = jsonData.coordinate;
                 if(coordinatesArea.code == 200){
                	 //坐标范围数组
                	 coordinatesArray = coordinatesArea.data;
                	 if(coordinatesArray!=null && coordinatesArray.length>0){
                		 for(var i=0; i<coordinatesArray.length; i++){
                			 var polygonArray = coordinatesArray[i];
                			 //var villageName = polygonArray.name;
                			 // var code = polygonArray.code;
                			 // var location = polygonArray.location;
                			 var areaName = polygonArray.areaName;
                			 var villageCoordinates = polygonArray.coordinate_range.coordinates[0];
                			 vallageCoordinatesArray.push(villageCoordinates);
                     		 //注意path是否有值
                			 polygonArray.polygonMap = vallagePolygon;
                     		 //coordinatesArrayCopy.push(polygonArray);
                     		if(areaName!=""){//混片
                     			areaCoordinatesArray.push(villageCoordinates);
                     		}else{//地采除混片的
                     			divideAreaCoordinatesArray.push(villageCoordinates);
                     		}
                			 /* $("#namelist").append("<li name='"+code+"' id='"+code+"' onclick='eventHandleNavList("+i+")'>"+
                                     "<p><span>"+(i+1)+".</span><span id='tinyvillage_"+code+"'>"+villageName+"</span></p>"+
                                     "<p><span ></span></p>"+
                                     "</li>"); */
                		 }
                		 vallagePolygon.setPath(vallageCoordinatesArray);
                	 }
                 }
                 $("#process_div").hide();
				 $("#process_div_pic").hide();
                 $("#search").keyup(function(th){
                     var searchStr = $("#search").val();
                     $("span[id^='tinyvillage_']").each(function(i,t){
                         var id =  $(t).attr("id");
                         var tinyname = $(t).text();
                         var idArr = id.split("_");

                         if(tinyname.indexOf(searchStr)<0){
                             $("#"+idArr[1]).hide();
                         }else{
                             $("#"+idArr[1]).show();
                         }
                     })
                 });
       	}else{
            $$.showMessage("系统信息", "数据加载异常！");
        }},true); 
});

 /* $(function(){
$("#process_div").show();
$("#process_div_pic").show();
 doManager("TinyAreaManager", "getTinyVillageCoordAndServiceArea",[cityId], function(data, textStatus,XMLHttpRequest) {
    if(data.result){
            jsonData = JSON.parse(data.data);
            //服务范围展示
            var serviceArea = jsonData.serviceArea;
            if(serviceArea.code == 200){
            	//服务范围数组
            	serviceArray = serviceArea.data;
            	var servicePolygon1 ;
            	if(serviceArray!=null && serviceArray.length>0){
            		var storeMarker;
                	for(var i=0;i<serviceArray.length;i++){
                		var polygonArray = serviceArray[i];
                		var storeName = polygonArray.areaName;
                		var serviceCoordinates=polygonArray.vertex;
                		servicePolygon1 = new AMap.Polygon({
                				path:serviceCoordinates,
                		       strokeColor: "#5c69cc", //线颜色
                		       strokeOpacity: 0.9, //线透明度
                		       strokeWeight: 2,    //线宽
                		       fillColor: "#046ad3", //填充色
                		       fillOpacity: 0.1//填充透明度
                		 });
                		servicePolygon1.setMap(map);
                		var position = servicePolygon1.getBounds().getCenter();
                		var storeMarker1 = new AMap.Marker({ //添加自定义点标记
            		        map: map,
            		        position: position, //基点位置
            		       // offset: new AMap.Pixel(strLength, -36), //相对于基点的偏移位置
            		       // draggable: true,  //是否可拖动
            		        content: '<div class="marker-route marker-marker-bus-from">'+storeName+'</div>',   //自定义点标记覆盖物内容,
            		        extData:{"id":i}
                		}); 
                		storeMarker1.on("click",function(e){
                			var id = e.target.getExtData().id;
                			var app = serviceArray[id];
                			var test = app.vertex;
                			test1.setPath(test);
                		});
                	}
            	}
            }
             $("#process_div").hide();
			 $("#process_div_pic").hide();
    }else{
        $$.showMessage("系统信息", "数据加载异常！");
    }},true); 
}); */


//多边形事件处理
/* var eventHandlePolygon = function (coordinatesArrayCopy,lastCode,e) {
	//初次选择对象，设置被选中对象的状态
	if(typeof(lastCode) == "undefined"){
		setPageStyle(coordinatesArrayCopy, lastCode, idx, true);
	}
} */

/* var marker;
var eventHandleNavList = function (i){
	if(typeof(marker) != "undefined"){
		map.remove(marker);
	}
	var location = coordinatesArray[i].location;
	map.setCenter(location);
	map.setZoom(15);
	marker = new AMap.Marker({
		 map: map,
	     position: location,
	     offset: new AMap.Pixel(-35, -35),
	     content: '<div class="marker-route marker-marker-bus-from">'+coordinatesArray[i].name+'</div>'
	});
} */

var storeNameClick = function(){
	for(var i=0;i<serviceArray.length;i++){
   		var polygonArray = serviceArray[i];
   		if(typeof(polygonArray.marker)!="undefined"){
   			if($('#storeNameClick').is(':checked')) {
       			polygonArray.marker.show();
       	    }else{
       	    	polygonArray.marker.hide();
       	    }
   		}
   	}
}

//运营覆盖范围点击事件
var operatedCoverage = function(){
   	if($('#serviceClick').is(':checked')) {
		servicePolygon.setPath(serviceCoordinatesArray);
  	}else{
  		servicePolygon.setPath([]);
  	}
}

 var landMiningAreaCoverage = function(id){
    var clickValue = $("#"+id).val();
    //地采选中
    var landminingClick = $('#landminingClick').is(':checked');
    //混片选中
    var areaClick = $('#areaClick').is(':checked');
    if(clickValue == "landmining"){//判断选中的是那一项
		if(landminingClick){//地采是选中状态
			if(areaClick){
				//设置为浅紫色 除混片外设置为浅紫色
				vallagePolygon.setPath(divideAreaCoordinatesArray);
			}else{
				//设置为浅紫色 所有坐标设置为浅紫色
				vallagePolygon.setPath(vallageCoordinatesArray);
			}
		}else{
			//设置为无色 所有坐标设置为无色
			vallagePolygon.setPath([]);
		}
	}else{
		if(areaClick){
			//设置为深紫色
			areaPolygon.setPath(areaCoordinatesArray);
		}else{
			if(landminingClick){
				//设置为浅紫色
				areaPolygon.setPath([]);
				vallagePolygon.setPath(vallageCoordinatesArray);
			}else{
				//设置为无色
				areaPolygon.setPath([]);
			}
		}
	}
}






</script>
</body>
</html>
