<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>社员价值统计</title>
    <link rel="shortcut icon" type="image/x-icon" href="../icon.png" />
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=0.3, maximum-scale=1, user-scalable=yes" name="viewport">  <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bootstrap/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="bootstrap/css/ionicons.min.css">
    <!-- Morris charts -->
    <link rel="stylesheet" href="plugins/morris/morris.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">
    <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker-bs3.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="plugins/select2/select2.min.css">
    <link rel="stylesheet" href="plugins/date-new/css/jquery-ui-1.9.2.custom.css" type="text/css">
    <link href="../scripts/css/auto.css" rel="stylesheet">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="IE 9/html5shiv.min.js"></script>
    <script src="IE 9/respond.min.js"></script>
    <![endif]-->
    <style>
        .box-default{border-bottom: 1px solid #e1e1e1;}
        .info_head{padding: 25px 0 35px 0;}
        .info_head img{width:123px; margin-top:10px;}
        .info_head span{padding-left: 20px;}
        .info_bottom{padding: 35px 20px 0 35px; font-size: 12px;}
        .info_bottom .text-right span{padding: 6px 12px; margin:0 20px 0 3px; display: inline-block;}
        .box .h4{padding-left:20px;}
        .nav-tabs-custom{padding:0 20px;}
        .nav-tabs{border:0;}
        .logo-lg li{float: left; position: relative;}

        .logo-lg i{color: #fff;}
        .nav_dropdown{ position: absolute;z-index: 10000; top: 70px; left: -10px; line-height: 22px; padding: 15px 25px; background-color: #15b092; display: none;}
        .nav_dropdown li{padding: 5px 0; line-height: 20px; white-space: nowrap; font-size: 14px;}
        .logo-lg > ul > li:hover > a{color: #001f3f; font-weight: bold;}
        .logo-lg > ul > li:hover i{ transform: rotate(180deg); transition: all 0.3s linear; color: #001f3f;}
        .table button{padding: 3px 20px; margin: 0 5px;}

        .tcdPageCode{padding: 15px 20px;text-align: left;color: #ccc;text-align:center;}
        .tcdPageCode a{display: inline-block;color: #428bca;display: inline-block;height: 25px;	line-height: 25px;	padding: 0 10px;border: 1px solid #ddd;	margin: 0 2px;border-radius: 4px;vertical-align: middle;}
        .tcdPageCode a:hover{text-decoration: none;border: 1px solid #428bca;}
        .tcdPageCode span.current{display: inline-block;height: 25px;line-height: 25px;padding: 0 10px;margin: 0 2px;color: #fff;background-color: #428bca;	border: 1px solid #428bca;border-radius: 4px;vertical-align: middle;}
        .tcdPageCode span.disabled{	display: inline-block;height: 25px;line-height: 25px;padding: 0 10px;margin: 0 2px;	color: #bfbfbf;background: #f2f2f2;border: 1px solid #bfbfbf;border-radius: 4px;vertical-align: middle;}
        .audit_process{ overflow-y: auto;  background: #f9f9f9; border-radius: 5px; padding:15px 0 20px 0;}
        .audit_process .clearfix{ padding:10px 30px;}
        .audit_margin{margin-right: 15px;}

        .box-header{margin-bottom: -15px;}
        #process_div{
            background-color:#292a2b;
            display:inline;
            z-index:100000;
            left:0px;
            opacity:0.3; top:0; left:0;height:100%; width:100%; z-index:999; position:fixed; _position:absolute; _left: expression_r(documentElement.scrollLeft + documentElement.clientWidth - this.offsetWidth); _top: expression_r(documentElement.scrollTop + documentElement.clientHeight - this.offsetHeight);
            filter:Alpha(Opacity=30);
            opacity: 0.3;
        }

        #process_div_pic{
            position:fixed;
            top:50%;
            left:50%;
            z-index:100000000;
            margin:-16px 0 0 -50px;
            width:100px;
            height:32px;
            color: #fff;
        }

        /*搜索框*/
        .form-control{height: 30px; line-height: 30px; border-radius: 6px; padding: 3px 8px;}
        /*更多显示*/
        .show-more-line{width: 100%; height: 40px; border-top: 1px dashed #e6e6e6; position: relative; background-color: #f5f5f5;}
        .how-more{position: absolute; top: -1px; left: 50%; background-color: #fff; border-left: 1px solid #e6e6e6; border-right: 1px solid #e6e6e6; border-bottom: 1px solid #e6e6e6;  padding: 5px 15px; margin: 0 0 0 -40px; color: #888; cursor: pointer; font-size: 12px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;}
        .how-more i{padding-left: 5px; font-size: 14px;}
        .fold-con,.sl-btns{display: none;}
        .selectorLine{border-top: 1px dashed #e6e6e6; padding: 10px 0 0 0; position: relative;}
        .selectorLine a{float: left; height: 18px; line-height: 18px; padding: 0 3px; margin: 2px 12px 12px 0; white-space: nowrap;}
        .selectorLine a:nth-child(1){margin-left: 15px;}
        .selectorLine a:hover{background-color: #ff7701; color: #fff;}
        .search-title{width: 100px; color: #777; white-space: nowrap; overflow: hidden; position: absolute; top: 10px; left: 0; text-align: right;}
        .search-con{margin-left: 100px; padding-right: 80px; overflow: hidden;}
        .search-time-con{margin-left: 0px; padding-right: 80px; overflow: hidden;}
        .sl-ext {position: absolute; top: 10px; right: 10px; width: 60px; height: auto; line-height: 22px; overflow: hidden; zoom: 1;}
        .search-more{width: 60px; height: 25px; line-height: 25px; padding: 0 7px 0 0; background: #fff; color: #333; border: 1px solid #ddd; font-size: 12px; position: relative; right: 0; top: 0;}
        .search-more i{position: absolute; top: 3px; right: 0; display: block; width: 20px; height: 20px; background-position: 4px 7px; font-size: 18px;}
        .search-more:hover{color: #e4393c;}
        .search-more-open i{ -webkit-transform: rotateX(180deg); -o-transform: rotateX(180deg); -moz-transform: rotateX(180deg);}
        .sx_type{margin-top: 5px;}
        .sx_type span{padding-right: 5px;}
        .sx_type span .icheckbox_minimal-blue{margin-right: 2px;}

        .auto{max-height:200px; overflow-y:scroll;}
        .opeDiv span{float: right;width: 46px;height: 24px;line-height: 24px;text-align: center;font-size: 12px;border: 1px solid #9fa3a8;border-radius: 3px;color: #616d73;margin: 0 13px 12px 0;box-shadow: 0 1px 5px rgba(0,0,0,0.3);cursor: pointer;}
        .Confirm{ background: linear-gradient(#83c56a, #63b254); border: 1px solid #46975d!important;; color: #fff!important;}
        .ui-close-date{color: #fff; font-size: 14px!important; float:right!important; margin-right:10px!important}
        .ui-datepicker-quick span{height: 30px; line-height: 35px}
        .ui-datepicker-time{background-color:transparent}
    </style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div id="process_div" style="display:none"></div>
<div id="process_div_pic" style="display:none"><img style="width:50px;height: 50px;" src="dist/img/376884043677306248.png"><i class="fa fa-refresh fa-spin"></i></div>
<!-- Site wrapper -->
<div class="wrapper">

    <header class="main-header">
        <nav class="navbar navbar-static-top">
            <div class="container">
                <div class="logo_img pull-left">
                    <img src="dist/img/logo.png" height="30">
                    <img src="dist/img/title.png" height="20">
                </div>
                <div class="pull-left">
                    <div class="logo-lg">
                        <ul class="no-margin">
                            <li class="current"><em>社员价值统计</em></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>
    </header>


    <!-- =============================================== -->

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!--  <div class="container"> -->
        <div>
            <!-- Main content -->

            <section class="content-header">
                <div class="box box-default">
                    <div class="box-header h4 text-light-blue">
                        <div class="pull-left "><strong>社员价值查询</strong></div>
                    </div>
                    <div class="box-body">
                        <div class="clearfix search-criteria">
                            <div class="selectorLine clearfix no-border">
                            <div class="search-title">查询条件：</div>
                            <div class="search-con" style="overflow:visible;">
                            <div class="sl-v-list">
                                <div class="clearfix">
                                    <div class="form-group col-lg-3">
                                        <select class="form-control select2" id="citySelect">
                                        </select>
                                    </div>
                                    <div class="form-group col-lg-3"><input id="store_id_manual" name="store_id_manual" type="hidden" bidTableFlag="true" value=""/>
                                        <input type="text" class="form-control"  placeholder="门店" id="store_name_manual" />
                                        <div class="auto hidden" id="auto" style="width: 94%;z-index: 99999;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </div>

                            <div class="search-time-con" style="overflow:visible;">
                            <div class="sl-v-list">
                            <div class="clearfix">
                                    <div class="search-con">
                                        <div class="time" style="width: 325px;z-index: 99999;margin:3px 15px;">
                                            <div class="time_endbg" id="time_endbg">
                                                <p>开卡日期选择：<span class="data_choice" id="data_choice">默认时期</span></p>
                                                <input type="text" class="ui-datepicker-time" id="searchTime" readonly value=""/>
                                            </div>
                                        </div>
                                        <div class="ui-datepicker-css" id="ui-datepicker-css" style="margin:0 15px 0 0;">
                                            <div class="ui-datepicker-quick" id="ui-datepicker-quick">
                                                <input class="ui-date-quick-button" type="button" value="今天" alt="0"  name=""/>
                                                <input class="ui-date-quick-button" type="button" value="昨天" alt="-1" name=""/>
                                                <input class="ui-date-quick-button" type="button" value="7天内" alt="-6" name=""/>
                                                <input class="ui-date-quick-button" type="button" value="30天内" alt="-29" name=""/>
                                                <input class="ui-date-quick-button" type="button" value="60天内" alt="-59" name=""/>
                                                <input class="ui-date-quick-button" type="button" value="全部" alt="1" name="">
                                                <span class="ui-close-date" id="ui-close-date" style="cursor:pointer;">X</span>
                                            </div>
                                            <div class="ui-datepicker-choose">
                                                <div class="ui-datepicker-date">
                                                    <input name="startDate" id="startOpenCardDate" class="startDate" readonly value="2018/05/21" type="text">
                                                    到
                                                    <input name="endDate" id="endOpenCardDate" class="endDate" readonly  value="2018/05/21" type="text" disabled>
                                                </div>
                                                <div class="opeDiv">
                                                    <span class="Cancel" id="Cancel">取消</span>
                                                    <span class="Confirm" id="Confirm" onclick="datePickersOpenCard()">确定</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                            </div>
                            </div>

                            <div class="fold-con">
                                <div class="selectorLine clearfix">
                                    <div class="pull-left search-title">社员信息：</div>
                                    <div class="search-con">
                                        <div class="sl-v-list">
                                            <div class="form-group has-success col-lg-3">
                                                <input type="text" class="form-control" id="member_invite_code"  placeholder="邀请码" onkeyup="value=value.replace(/(\s*)|(\s*)/g,'').replace(/[ ]/g,'')" />
                                            </div>
                                            <div class="form-group has-success col-lg-3">
                                                <input type="text" class="form-control" id="member_mobile_phone"  placeholder="手机号" onkeyup="value=value.replace(/(\s*)|(\s*)/g,'').replace(/[ ]/g,'')" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="show-more-line">
                            <div class="how-more"><span>更多搜索选项</span><i class="fa fa-angle-down"></i></div>
                        </div>
                        </div>
                        <div class="clearfix">
                            <div class="form-group col-lg-2 pull-right" style="padding-top: 25px;">
                                <button type="button" onclick="resetSerachParam(1)" style="border-color:#00a65a;background-color:#00a652;color:white" class="btn btn-block">重置</button>
                            </div>
                            <div class="form-group col-lg-2 pull-right" style="padding-top: 25px;">
                                <button type="button" id="export_auto_publicOrder_button" onclick="export_auto_human('normal')" class="btn btn-block btn-warning">导出</button>
                            </div>
                            <div class="form-group col-lg-2 pull-right" style="padding-top: 25px;">
                                <button type="button" onclick="search_auto_abnormalOrder(1)" class="btn btn-block btn-primary">查询</button>
                            </div>
                        </div>

                    </div>

                    <div class="box-body">
                        <div class="tab-content">
                            <table class="table table-striped no-margin">
                                <tbody id="manual_tbody">
                                <tr id="auto_title">
                                    <th width="10%">社员手机号</th>
                                    <th width="10%">社员开卡时间</th>
                                    <th width="10%">邀请码</th>
                                    <th width="10%">城市</th>
                                    <th width="10%">开卡门店</th>
                                    <th width="10%">开卡礼</th>
                                    <th width="10%">累计粮票</th>
                                    <th width="10%">剩余粮票</th>
                                    <th width="10%">节省金额</th>
                                    <th width="10%"><font id="columnattention2" style="color:#337ab7;font-size:14px;font-weight:normal;">！</font>
                                        <font id="forcolumnattention2" style="color:#47b8ef;font-size: 12px;white-space: nowrap;position: absolute;top:-8px;z-index: 1000;display:none;margin-left: -110px;">199-149(已领开卡礼)-已用粮票-节省金额</font>剩余价值</th>
                                </tr>

                                </tbody>
                            </table>

                            <!-- /.tab-pane -->
                        </div>

                        <div style="position:absolute;bottom:6px;left:27px;width:25%">显示 <select id="pageRecords_manual" name="pageRecords_manual" onchange="chnagePageRecords(2)"  style="height:25px;line-height:25px;border-radius:4px;"><option value="10" selected="selected">10</option><option value="50">50</option><option value="100">100</option></select> 条 &nbsp;&nbsp; 共  <span id="totalRecord_cannot"></span> 条</div>
                        <div class="tcdPageCode" id="page_manual"></div>

                        </div>
                </div>

            </section>

        </div>
    </div>
    <!-- /.content-wrapper -->


</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.0 -->
<script src="plugins/jQuery/jQuery-2.2.0.min.js"></script>
<script src="plugins/date-new/js/jquery-ui-1.9.2.custom.js" type = "text/javascript"></script>
<script src="plugins/date-new/js/share.js" type = "text/javascript"></script>
<!-- Bootstrap 3.3.6 -->
<script src="bootstrap/js/bootstrap.min.js"></script>
<!-- Morris.js charts -->
<script src="bootstrap/js/raphael-min.js"></script>
<script src="plugins/morris/morris.min.js"></script>
<!-- FastClick -->
<script src="plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>
<!-- page script -->
<script type="text/javascript" src="plugins/jquery.page.js"></script>
<script type="text/javascript" src="plugins/moment.min.js"></script>
<script type="text/javascript" src="plugins/daterangepicker/daterangepicker.js"></script>
<script type="text/javascript" src="../scripts/bidLibjsjquery3.0.js"></script>
<script type="text/javascript" src="../scripts/auto.js"></script>

<script tyle="text/javascript">
    Date.prototype.format=function(fmt) {
        var o = {
            "M+" : this.getMonth()+1, //月份
            "d+" : this.getDate(), //日
            "h+" : this.getHours()%12 == 0 ? 12 : this.getHours()%12, //小时
            "H+" : this.getHours(), //小时
            "m+" : this.getMinutes(), //分
            "s+" : this.getSeconds(), //秒
            "q+" : Math.floor((this.getMonth()+3)/3), //季度
            "S" : this.getMilliseconds() //毫秒
        };
        var week = {
            "0" : "\u65e5",
            "1" : "\u4e00",
            "2" : "\u4e8c",
            "3" : "\u4e09",
            "4" : "\u56db",
            "5" : "\u4e94",
            "6" : "\u516d"
        };
        if(/(y+)/.test(fmt)){
            fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
        }
        if(/(E+)/.test(fmt)){
            fmt=fmt.replace(RegExp.$1, ((RegExp.$1.length>1) ? (RegExp.$1.length>2 ? "\u661f\u671f" : "\u5468") : "")+week[this.getDay()+""]);
        }
        for(var k in o){
            if(new RegExp("("+ k +")").test(fmt)){
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
            }
        }
        return fmt;
    }


    layer.config({

        extend: 'skin/crmskin/style.css' //加载新皮肤

    });

    var cityId = decode64(getUrlParamByKey("c"));//城市ID
    var employeeId = decode64(getUrlParamByKey("e"));//员工ID
    var storeId = decode64(getUrlParamByKey("s"));//门店ID
    var target = decode64(getUrlParamByKey("t"));//执行人级别
    var storeName=decode64(getUrlParamByKey("sn"));//门店名称
    var storeno = decode64(getUrlParamByKey("so"));//门店编号
    var role = decode64(getUrlParamByKey("r"));//角色 code
    var cityname = decode64(getUrlParamByKey("cn"));//城市名称
    var deptname = decode64(getUrlParamByKey("dn"));//事业部名称
    var employeeName = decode64(getUrlParamByKey("en"));//员工姓名
    var employeePhone = decode64(getUrlParamByKey("ep"));//员工手机号
    var time = decode64(getUrlParamByKey("time"));//开卡时间
    var inviteCode = decode64(getUrlParamByKey("ic"));//邀请码

    /* 	$('#sign_time').datepicker({
              autoclose: true
            }); */

    $(function () {

        $(".logo-lg > ul > li").mouseenter(function(){
            $(this).children(".nav_dropdown").show();
        });
        $(".logo-lg > ul > li").mouseleave(function(){
            $(this).children(".nav_dropdown").hide();
        });
        $("#ui-datepicker-quick input").click(function(){
            var buttonValue= $(this).val();
            $('#data_choice').html(buttonValue);
        });

        initcurruser();//初始化登录人信息
        var isManager = currentUser.usergroup.code;
        if(isManager=="GLY" || isManager=="ZBYYZLKZJSZ"){
            var exportnormal = document.getElementById("exportnormal");
            exportnormal.style.display = "none";
            var exportall = document.getElementById("exportall");
            exportall.style.display = "block";
        }

        if(target==0){//总部
            initallcity();
            initallstore();
        }else if(target==1){//城市
            initcurcity();
            $("#citySelect option[value='"+cityId+"']").attr('selected',true);
            initStoreSelectcomplate();
        }else if(target==2) {//门店
            initcurcity();
            $("#citySelect").prop("disabled", true);
            $("#citySelect").append('<option value="'+cityId+'">'+cityname+'</option>');
            initStoreSelectcomplate();
            $("#store_id_manual").val(storeId);
            $("#store_name_manual").val(storeName);
            $("#store_name_manual").attr("readonly",true);
        }

        var autoComplete = new AutoComplete("store_name_manual","auto",array);
        document.getElementById("store_name_manual").onkeyup = function(event){
            autoComplete.start(event);
            if($("#store_name_manual").val().trim() == ""){
                $("#store_id_manual").val("");
            }
            for(var key in storeJson){
                if(document.getElementById("store_name_manual").value==key){
                    document.getElementById("store_id_manual").value=storeJson[key];
                }
            }
        }
        $("#auto").on("click",function(event){
            for(var key in storeJson){
                if(document.getElementById("store_name_manual").value==key){
                    document.getElementById("store_id_manual").value=storeJson[key];
                }
            }
        });

        //更多显示
        $(".how-more").click(function(){
            var sl_open = $(".fold-con").css("display");
            if(sl_open == 'none'){
                $(this).parent().prev().children().next(".fold-con").show();
                $(this).children("span").html("收起更多选项");
                $(this).children("span").addClass("search-more-open");
            } else if(sl_open == 'block'){
                $(this).parent().prev().children().next(".fold-con").hide();
                $(this).children("span").html("更多搜索选项");
                $(this).children("span").removeClass("search-more-open");
            }
        });

        //从社员邀请统计页跳转携带开卡时间
        if(time!="" && time!=null){
            $("#searchTime").val(time);
            $("#startOpenCardDate").val(time.split('-')[0]);
            $("#endOpenCardDate").val(time.split('-')[1]);
            $("#member_invite_code").val(inviteCode);
            search_auto_abnormalOrder(1);
        }

    });

    function initallcity(){
        doManager("DistCityCodeManager","queryAllDistCityList",null,
            function(data,textStatus,XmlHttpRequest){
                if (data.result) {
                    var jsonData = $.fromJSON(data.data);
                    $("#citySelect").append("<option value=''>全部城市</option>");
                    $(jsonData).each(function(index,element){
                        $("#citySelect").append('<option value="'+element.cityno+'">'+element.cityname+'</option>');
                    });
                }
            },false);
    }

    var array=new Array();
    //初始化所有门店
    function initallstore() {
        doManager("StoreManager", "findStoreAll", null,
            function(data, textStatus, XMLHttpRequest) {
                if (data.result) {
                    var jsonData = $.fromJSON(data.data);
                    array = new Array();
                    var storeString = "";
                    for(var i=0;i<jsonData.length;i++){
                        array.push(jsonData[i].name);
                        if(i == 0){
                            storeString = "{'"+jsonData[i].name+"'"+":"+"'"+jsonData[i].id+"'"+",";
                        }else if(i == jsonData.length-1){
                            storeString = storeString+"'"+jsonData[i].name+"'"+":"+"'"+jsonData[i].id+"'"+"}";
                        }else{
                            storeString = storeString+"'"+jsonData[i].name+"'"+":"+"'"+jsonData[i].id+"'"+",";
                        }
                    }
                    storeJson=$.fromJSON(storeString);
                    var autoComplete = new AutoComplete("store_name_manual","auto",array);
                    document.getElementById("store_name_manual").onkeyup = function(event){
                        autoComplete.start(event);
                        if($("#store_name_manual").val().trim() == ""){
                            $("#store_id_manual").val("");
                        }
                        document.getElementById("store_name_manual").value=document.getElementById("store_name_manual").value.replace(/(\s*)|(\s*)/g,'').replace(/[ ]/g,'');
                    }
                }
            }, false);
    }

    function initcurcity(){
        doManager("userManager","getCurrentUserCity",null,
            function(data,textStatus,XmlHttpRequest){
                if (data.result) {
                    var jsonData = $.fromJSON(data.data);
                    $(jsonData).each(function(index,element){
                        doManager("massOrderManager","queryCitynoByCode",element.citycode,
                            function(data2,textStatus,XmlHttpRequest){
                                if (data2.result) {
                                    var jsonData2 = $.fromJSON(data2.data);
                                    $("#citySelect").append('<option value="'+jsonData2.cityno+'">'+element.cityname+'</option>');
                                }
                            },false);
                    });
                }
            },false);
    }

    $("#citySelect").change(function(){
        $("#store_id_manual").val("");
        $("#store_name_manual").val("");
        initStoreSelectcomplate();
    });

    var storeJson;
    function initStoreSelectcomplate(){
        var citySelect = $("#citySelect").find("option:selected").text();
        $("#auto").val("");
        if(citySelect=="" || citySelect=="全部城市"){
            initallstore();
        }else{
            //根据城市查询门店 信息
            var cityname = "'"+citySelect+"'";
            doManager("StoreManager","findStoreByCityData",[cityname],
                function(data,textStatus,XmlHttpRequest){
                    if (data.result) {
                        var jsonData = $.fromJSON(data.data);
                        array=new Array();
                        var storeString = "";
                        $(jsonData).each(function(index,element){
                            var storeName = element.name;
                            var storeid = element.id;
                            array.push(storeName);
                            if(index == 0 || index == jsonData.length-1){
                                if(index == 0){
                                    storeString = "{'"+storeName+"'"+":"+"'"+storeid+"'"+",";
                                }
                                if(index == jsonData.length-1){
                                    storeString = storeString+"'"+storeName+"'"+":"+"'"+storeid+"'"+"}";
                                }
                            }else{
                                storeString = storeString+"'"+storeName+"'"+":"+"'"+storeid+"'"+",";
                            }
                        });
                        storeJson=$.fromJSON(storeString);
                        var autoCompleteName = new AutoComplete("store_name_manual","auto",array);
                        document.getElementById("store_name_manual").onkeyup = function(event){
                            autoCompleteName.start(event);
                            if($("#store_name_manual").val().trim() == ""){
                                $("#store_id_manual").val("");
                            }
                            document.getElementById("store_name_manual").value=document.getElementById("store_name_manual").value.replace(/(\s*)|(\s*)/g,'').replace(/[ ]/g,'');
                        }
                    }
                },false);
        }

    }

    function isCityStore(sname){
        var cityStore = false;
        $(array).each(function(index,element){
            if(element==sname){
                cityStore=true;
            }
        });
        return cityStore;
    }

    var currentUser;
    function initcurruser(){
        //取得当前登录人的门店
        doManager("UserManager", "getCurrentUserDTO",null,
            function(data, textStatus, XMLHttpRequest) {
                if (data.result) {
                    var curr_user = JSON.parse(data.data);
                    currentUser = curr_user;
                }
            },false);
    }

    var isCreatePage=false;
    function search_auto_abnormalOrder(cur_page){
        isCreatePage=false;
        search_auto_abnormalOrder1(cur_page);

    }

    //查询上
    var currentPage_auto= 1;
    var totalPage_auto = 1;
    function  search_auto_abnormalOrder1(cur_page){

        var cityName = $("#citySelect option:selected").val();
        var number_str = $("#store_id_manual").val();
        var storeName = $("#store_name_manual").val();
        if(storeName!=""){
            if($.inArray(storeName, array) == -1){
                crm_alert(0,"该门店不存在！");
                return;
            }
        }
        if(number_str==""&&storeName!=""){
            number_str=-10000;
        }

        $("#process_div").show();
        $("#process_div_pic").show();

        var memberInviteCode = $("#member_invite_code").val();
        var memberMobilePhone = $("#member_mobile_phone").val();
        //社员开卡时间
        var ocdate = $("#searchTime").val();
        var opencard_begin_end_date=["",""];
        if(ocdate!=""){
            opencard_begin_end_date = ocdate.split("-");
        }
        var opencard_begin_time = opencard_begin_end_date[0].trim();
        var opencard_end_time = opencard_begin_end_date[1].trim();


        var memberDataDto=null;
        memberDataDto = {
            cityName:cityName,
            storeNo:number_str,
            inviteCode:memberInviteCode,
            mobilePhone:memberMobilePhone,
            open_card_time_begin:opencard_begin_time,
            open_card_time_end:opencard_end_time
        }

        var pageInfo = new Object();
        pageInfo.currentPage = cur_page;
        pageInfo.recordsPerPage = manualPageRecordes;
        $("#totalRecord_cannot").html("0");

        doManager('communeMember','queryRemainMemberList',[memberDataDto,pageInfo],function(data){
            if(data.result){
                var result= JSON.parse(data.data);
                if(result.status=='success'){
                    $("#manual_tbody").find("tr:gt(0)").remove();
                    var jData = result.member;
                    if(jData==null||jData.length==0){
                        crm_alert(5,"系统查无此条件的数据");
                        $("#page_manual").createPage({
                            pageCount:0,
                            current:0,
                            backFn:function(p){

                            }
                        });
                        $("#process_div").hide();
                        $("#process_div_pic").hide();
                        return;
                    }
                    totalPage_manual = result.total_pages;
                    $("#totalRecord_cannot").html(result.pageinfo.totalRecords);
                    if(!isCreatePage){

                        $("#page_manual").createPage({
                            pageCount:totalPage_manual,
                            current:1,
                            backFn:function(p){

                                search_auto_abnormalOrder1(p);
                            }
                        });
                        isCreatePage=true;
                    }

                    var infoStr="";
                    for(var i=0;i<jData.length;i++){
                        var opencard="";
                        if(jData[i].opencard_time!=null){
                            var d=	new Date();
                            d.setTime(jData[i].opencard_time);
                            opencard=jData[i].opencard_time;//d.format('yyyy-MM-dd HH:mm:ss')
                        }

                        var mobilephone = jData[i].mobilephone;
                        var cphone="<strong>手机号：</strong>"+mobilephone+"<br>";
                        var csource="<strong>用户来源：</strong>"+jData[i].customer_source;
                        var phonecontent =cphone+csource+"@phonetips"+i;
                        var phoneid = "phonetips"+i;
                        var city_name = jData[i].cityname;
                        var store_name = jData[i].store_name;
                        var store_no = jData[i].store_no;
                        var opengift = jData[i].opengift;
                        var sum_rebate = jData[i].sum_rebate;
                        var remain_rebate = jData[i].remain_rebate;
                        var mon_conpon = jData[i].mon_conpon;
                        var remain = jData[i].remain;
                        var sum_retrench_money = jData[i].sum_retrench_money;

                        infoStr= "<tr>";
                        infoStr= infoStr
                            +"<td><a style=\"text-decoration:underline\" href=\"javascript:showuserprofile('"+jData[i].customer_id+"','"+mobilephone+"','"+city_name+"','"+store_name+"','"+store_no+"','"+ocdate+"')\" onmouseover=\"showphone('"+phonecontent+"');\" id=\""+phoneid+"\">"+mobilephone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')+"</a></td>"
                            +"<td>"+opencard+"</a></td>";
                        if(target==0 || target==1){
                            infoStr= infoStr
                                +"<td><a href=\"javascript:showemployee('"+jData[i].invitecode+"')\">"+jData[i].invitecode+"</a></td>";
                        }else{
                            infoStr= infoStr
                                +"<td>"+jData[i].inviteCode+"</td>";
                        }
                        infoStr= infoStr
                            +"<td>"+city_name+"</td>"
                            +"<td>"+store_name+"</td>"
                            +"<td>"+opengift+"</td>"
                            +"<td>"+sum_rebate+"</td>"
                            +"<td>"+remain_rebate+"</td>"
                            +"<td>"+sum_retrench_money+"</td>"
                            +"<td>"+remain+"</td>";

                        infoStr= infoStr
                            +"</tr>";

                        $("#manual_tbody").append(infoStr);
                    }
                }else{
                    crm_alert(5,"请稍后重新请求！");
                }

            }else{
                crm_alert(5,"请稍后重新请求！");
            }
            $("#process_div").hide();
            $("#process_div_pic").hide();
        });

    }

    //社员手机号信息显示
    function showphone(obj){
        var msg = obj.split("@")[0];
        var id = obj.split("@")[1];
        layer.tips(msg, '#'+id, {
            tips: [4, '#0FA6D8'], //还可配置颜色
            time:5000
        });
    }

    //数据查询-用户档案
    function showuserprofile(customer_id,mobilephone,city_name,store_name,store_no,ocdate){
        doManager('userProfileManager','queryRecentlyOrder',[customer_id],function(data){
            if(data.result){
                var result= JSON.parse(data.data);
                if(result!=null){
                    var jData = result.data;
                    if(jData!=null && jData.length>0){
                        var url = "userProfile_view.html?t="+encode64(target)+"&sn="+encode64(store_name)+"&cn="+encode64(city_name)+"&so="+encode64(store_no)+"&mp="+encode64(mobilephone)+"&tag="+encode64("V")+"&time="+encode64(ocdate);
                        window.open(url,"userProfile_view");
                    }else{
                        crm_alert(5,"暂无消费信息！");
                    }

                }
            }
        });
    }
    
    //数据查找-员工数据
    function showemployee(inviteCode){
        var url = "humanresources_list.html?t="+encode64(target)+"&sn="+encode64(storeName)+"&cn="+encode64(cityname)+"&ic="+encode64(inviteCode);
        window.open(url,"humanresources_list");
    }

    function isnull(str) {
        return str == null || str == "null" || str == "" || str == "undefined" || typeof(str) == "undefined";
    }


    function resetSerachParam(t){
        if(target==0){//总部
            var a = document.getElementById("citySelect");
            a.options[0].selected = true;
            $("#store_name_manual").val("");
            initallstore();
        }else if(target==1){
            $("#store_name_manual").val("");
            initStoreSelectcomplate();
        }
        $("#store_id_manual").val("");
        $("#member_invite_code").val("");
        $("#member_mobile_phone").val("");
        var nowDate = new Date();
        var month = nowDate.getMonth()+1;
        var date = nowDate.getDate();
        timeStr = nowDate.getFullYear() + '/' + (month < 10 ? '0' + month : '' + month) + '/' + (date < 10 ? '0' + date : '' + date);
        nowDate.setDate(nowDate.getDate()+parseInt(-1));
        var startDateStr = nowDate.getFullYear() + '/' + (month < 10 ? '0' + month : '' + month) + '/01';
        $("#searchTime").val(startDateStr +"-"+ timeStr);
        $("#data_choice").html("默认时期");
    }

    var autoPageRecordes=10;
    var manualPageRecordes=10;
    //切换每页显示的数据量
    function chnagePageRecords(t){
        $("#page_manual").empty();
        manualPageRecordes  = $("#pageRecords_manual").val();
        search_auto_abnormalOrder(1);
    }

    function export_auto_human(hiddenvalue){

        var cityName = $("#citySelect option:selected").val();
        var number_str = $("#store_id_manual").val();
        var storeName = $("#store_name_manual").val();
        if(storeName!=""){
            if($.inArray(storeName, array) == -1){
                crm_alert(0,"该门店不存在！");
                return;
            }
        }
        if(number_str==""&&storeName!=""){
            number_str=-10000;
        }

        $("#process_div").show();
        $("#process_div_pic").show();

        var memberInviteCode = $("#member_invite_code").val();
        var memberMobilePhone = $("#member_mobile_phone").val();
        //社员开卡时间
        var ocdate = $("#searchTime").val();
        var opencard_begin_end_date=["",""];
        if(ocdate!=""){
            opencard_begin_end_date = ocdate.split("-");
        }
        var opencard_begin_time = opencard_begin_end_date[0].trim();
        var opencard_end_time = opencard_begin_end_date[1].trim();

        var memberDataDto=null;
        memberDataDto = {
            cityName:cityName,
            storeNo:number_str,
            inviteCode:memberInviteCode,
            mobilePhone:memberMobilePhone,
            hidden_flag:hiddenvalue,
            open_card_time_begin:opencard_begin_time,
            open_card_time_end:opencard_end_time
        }

        doManager('communeMember','exportRemainMember',[memberDataDto],function(data){
            if(data.result){
                var result= JSON.parse(data.data);
                if(result.status=='success'){
                    window.location.href=result.data;
                }else if(result.status=="more"){
                    crm_alert(0,"单次导出不能超过5万条记录，请调整搜索条件，确认结果条数后再试。");
                    $("#process_div").hide();
                    $("#process_div_pic").hide();
                }
                else if(result.status=="null"){
                    crm_alert(0,"请先确认是否有符合条件的数据，重新请求！");
                    $("#process_div").hide();
                    $("#process_div_pic").hide();
                    return;
                }else{
                    crm_alert(5,"请稍后重新请求！");
                    $("#process_div").hide();
                    $("#process_div_pic").hide();
                    return;
                }

            }else{
                crm_alert(5,"请稍后重新请求！");
            }
            $("#process_div").hide();
            $("#process_div_pic").hide();
        });
    }
    $("#columnattention2").on("mouseover",function(event){
        $("#forcolumnattention2").show();
    });
    $("#columnattention2").on("mouseout",function(event){
        $("#forcolumnattention2").hide();
    });

</script>
</body>

<div class="audit_process" id="taskDetailDiv" style="display:none">
</div>


<div id="errorOrder_detail_div" style="height:247px;display:none">

</div>
</html>