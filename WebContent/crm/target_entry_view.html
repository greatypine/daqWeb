<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>目标值信息列表</title>
    <script type="text/javascript" src="../scripts/bidLib.js"></script>
    <link href="../startbootstrap/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../startbootstrap/bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <link href="../startbootstrap/dist/css/sb-admin-2.css" rel="stylesheet">
    <link href="../startbootstrap/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet"
          type="text/css">
</head>
<style type="text/css">
    	.display{
    		width:100%
    	}
        table input,table select{border:1px solid #ccc; border-radius:3px; line-height: 30px; height: 30px; width:65%;}
</style>
<script type="text/javascript">
var win;
$(function () {
	//获取当前登录的用户
	 doManager("UserManager", "findUserInfo", null, function(
							data, textStatus, XMLHttpRequest) {
						if (data.result) {
							if(data.data!="null"){
								var jsonData = $.fromJSON(data.data);
								if(jsonData==3223||jsonData==3224||jsonData==3225){
									$("#inser").hide();
									//$pmspage.opArr = [ editObj  ];  
								}else{
									//判断是否可修改
									//val flag = booleanCanEdit();
									//$pmspage.opArr = [ editObj  ];  
								}
								//console.log(jsonData);
							}
						} else {
							$$.showMessage("系统信息", "信息加载异常!");
						}
					},false);
    //页面加载成功后需要获取数据
    searchList();
    $(".operateHeader").width("5%");
});
//记载页面时请求数据列表默认的方法
function searchList() {
    $$.executeSearch('targetEntry', 'conditionsDiv');
    $(".operateHeader").width("5%");
}
function doClean() {
    document.service_qa.reset();
    searchList();
}
function insertTown(){
	window.location.href="target_entry_list_add.html";
}

var editObj = {
		html : '<a href="#" class="blue">修改</a>',
		resourceId: "office_List_edit",
		func : function(queryid, data, nTr, allColumns, allColumnsDataMap) {
			var id = allColumnsDataMap.id;
			window.location.href = "target_entry_list_edit.html?id="+id;
		}
	}
var COLUMNS = {
		   "caozuo": function(aData, iColumn, sColumnName, map){
				 var id = map['id'];
               var frame_time =fmtDate(map['frame_time']);
               return '<a href="target_entry_list_edit.html?id='+id+'">编辑</a>';
//				 var start_time = map['time_period'].split("~")[0];
//				 var end_time = map['time_period'].split("~")[1];
//				 var myDate = new Date();
//				 var date = myDate.toLocaleDateString(); //获取当前日期
//				 if(Date.parse(date) < Date.parse(end_time)) {//时间戳对比
//					return '<a href="office_network_list_edit.html?id='+id+'">编辑</a>';
//			     }else{
//			    	 return '';
//			     }
		    }
}

function fmtDate(obj){
    var date =  new Date(obj);
    var y = 1900+date.getYear();
    var m = "0"+(date.getMonth()+1);
    var d = "0"+date.getDate();
    return y+"-"+m.substring(m.length-2,m.length)+"-"+d.substring(d.length-2,d.length);
}

function showcardinfo(file_name){

//    var rootPath = "https://cdn.guoanshuju.com/upload_folder/siteselection/";
//    $("#showcard").attr("src",rootPath+file_name);

    var imgdiv = $("#showcarddiv");
    imgdiv.dialog({
        bgiframe : true,
        title : "目标录入",
        width : 680,
        height: 450,
        buttons : {
            "确定" : function() {
                yanzhen();
                $(this).dialog("close");
            },
            "取消" : function() {
                $(this).dialog("close");
            }
        },
        modal : false
    });
}


function yanzhen(){

    var weekSelect = $("#frame_time").val();
    if(weekSelect == null||weekSelect == ""){
        alert("录入时间不能为空");
        return;
    }
    var maori_target=$("#maori_target").val().replace(/(^\s*)|(\s*$)/g, "");
    if(maori_target==null||maori_target==""){
        alert("毛利不能为空");
        return;
    }
    var profit_target=$("#profit_target").val().replace(/(^\s*)|(\s*$)/g, "");
    if(profit_target==null||profit_target==""){
        alert("利润不能为空");
        return;
    }
    var user_target=$("#user_target").val().replace(/(^\s*)|(\s*$)/g, "");
    if(user_target == "" || user_target == null){
        alert("用户不能为空!");
        return;
    }
//    if(!isNumber(maori_target)){
//        alert("毛利必须为数字");
//        return;
//    }
//    if(!isNumber(profit_target)){
//        alert("利润必须为数字");
//        return;
//    }
//    if(!isNumber(user_target)){
//        alert("用户必须为数字");
//        return;
//    }

    var citySelect = $("#citySelect").val();
    if(citySelect == null||citySelect == "0"){
        alert("城市不能为空");
        return;
    }
    yanzhenAdd();
}

function yanzhenAdd(){
    var statistics=$("#frame_time").val();
    var city_name=$("#city_name").val();
    doManager("targetEntryManager", "getByTarget",[statistics,city_name] , function(data,
                                                                                    textStatus, XMLHttpRequest) {
        if (data.result) {
            var resultJson= JSON.parse(data.data);
            var task_quantity_count = JSON.parse(resultJson.statistics);
            if(parseInt(task_quantity_count)!=0){
                alert("该目标值已录入,请返回列表修改!");
                return;
            }
            doSave();
        }else{
            $$.showMessage("系统信息", "信息加载异常");
            return;;
        }
    });
}
function doSave(){
    var arr = [ "frame_time", "businessGroup_name","businessGroup_code","city_name","city_code","maori_target","profit_target","user_target","id"];
    var o = {};
    for ( var i in arr) {
        var v = arr[i];
        var va = $("#" + v).val();
        o[v] = va;
    }
    doManager("targetEntryManager", "saveOrUpdateTargetEntry", o, function(data,
                                                                           textStatus, XMLHttpRequest) {
        if (data.result) {
            var jsonData = $.fromJSON(data.data);
            alert("添加成功！");
            window.location.href = 'target_entry_view.html';
        } else {
            $$.showMessage("系统信息", "添加失败!");
        }
    });
}
$(function(){
    initcurruser();
    var regex_cs = new RegExp("^(CS|cs)\w*");//城市级别
    if(regex_cs.test(curr_user.usergroup.code)||curr_user.usergroup.code=="PTYYZXYCDDZ"){
        initcurcity();
    }else{
        initallcity();
    }
});
function initallcity(){
    doManager("DistCityCodeManager","queryAllDistCityList",null,
        function(data,textStatus,XmlHttpRequest){
            if (data.result) {
                var jsonData = $.fromJSON(data.data);
                //$("#citySelect").append("<option value='0'>全部城市</option>");
                $(jsonData).each(function(index,element){
                    if(index==0){
                        $("#city_name").val(element.cityname);
                        $("#city_code").val(element.cityno);
                    }
                    $("#citySelect").append('<option value="'+element.cityno+'">'+element.cityname+'</option>');
                });
            }
        });
}
function initcurcity(){
    doManager("DistCityCodeManager","queryAllDistCityList",null,
        function(data,textStatus,XmlHttpRequest){
            if (data.result) {
                var jsonData = $.fromJSON(data.data);
                giveCityNo(datas,jsonData);
            }
        });
    doManager("userManager","getCurrentUserCity",null,
        function(data,textStatus,XmlHttpRequest){
            if (data.result) {
                var jsonData = $.fromJSON(data.data);
                var IndexSelected = "";
                $(jsonData).each(function(index,element){
                    var index = findArray(datas, {value: element.cityname});
                    $("#citySelect").append('<option value="'+datas[index].name+'">'+element.cityname+'</option>');
                    if(index==0){
                        $("#cityname").val(element.cityname);
                        $("#cityno").val(datas[index].name);
                    }
                });
                $("#citySelect")[0].selectedIndex = IndexSelected;
            }
        });
}
function giveCityNo(datas,jsonData){
    $(jsonData).each(function(index,element){
        var object = new Object();
        object.name = jsonData[index]['city_code'];
        object.value = jsonData[index]['city_name'];
        datas.push(object);
    });

}
var curr_user;
function initcurruser(){

    //取得当前登录人的门店
    doManager("UserManager", "getCurrentUserDTO",null,
        function(data, textStatus, XMLHttpRequest) {
            if (data.result) {
                var employeeID="";
                curr_user = JSON.parse(data.data);
            }
        },false);
}

function select_data(){
    var cityno = $("#citySelect").val();
    var index=$("#citySelect")[0].selectedIndex ;
    var cityname = $("#citySelect")[0].options[index].text;
    $("#city_name").val(cityname);
    $("#city_code").val(cityno);
    //查询本年是否录入过合作店和自营店任务目标(如果填过只能修改不能新增)
    //queryTaskQuantity(cityname,cityno);
}
</script>
<body style="height: 100%">
	<div class="panel panel-default" style="margin: 10px">
	    <div class="panel-heading">
	        <h4 class="panel-title">
	           目标值录入信息:
	        </h4>
	    </div>
	</div>
	    <div class="panel panel-primary">
        <div class="panel-heading">目标值录入信息查询</div>
        <div class="panel-body">
            <div id="conditionsDiv" style="margin-top: 10px">
                <form id="service_qa" name="service_qa" class="pmsForm" validate="true" clientvalidate="true"
                      displaynumber="7">
                    <table id="searchTable" cellpadding="0" cellspacing="0" style="min-width: 100%; width: auto">
                        <tr>
                            <td width="7%">统计时间段:</td>
                            <td>
                                <input id="period_type" name="period_type" type="text" style="width:60%" class="form-control"/>
                            </td>
                            <td width="7%">城市:</td>
                            <td>
                                <input id="cityname" name="cityname" type="text" style="width:60%" class="form-control"/>
                            </td>
                            <td width="7%">频道:</td>
                            <td>
                                <input id="channel" name="channel" type="text" style="width:60%" class="form-control"/>
                            </td>

                        </tr>
                    </table>
                </form>
            </div>
        </div>
        <div class="panel-footer" style="text-align: right">
            <button class="btn btn-primary" onclick="searchList()">查询</button>
            <button class="btn btn-primary" id="inser" onclick="showcardinfo()">添加</button>
            <button class="btn btn-primary" onclick="doClean();">重置</button>
        </div>
    </div>
    <div id="showcarddiv" class="panel panel-primary" style="display: none;">
        <div class="panel panel-primary" style="margin: 10px 5px 0 5px">

            <div class="panel-body" id="temp1">
                <form action="" method="post" class="pmsForm">
                    <input type="hidden" name="county_id" id="county_id"/>
                    <input type="hidden" name="id" id="id"/>
                    <table width="100%">
                        <tr>
                            <td width="45%">
                                <p class="read">统计时间：<span style="color: red" id="statistics">*</span></p>
                                <p class="read"><input id="frame_time" revalidate="true"
                                                       type="text" likeOption="false" name="date"
                                                       validate="formatDate:true" class="pmsDateField form-control"
                                                       yearRange="-100:+10" style="width: 65%; display: inline;"
                                                       readonly />
                                </p>
                            </td>
                            <td width="45%">
                                <p class="read">事业群/频道：<span style="color: red">*</span></p>
                                <p class="read"><select id="businessGroup" style="width: 65%" onchange="select_data();"></select><input type="hidden" id="businessGroup_name" name="businessGroup_name"><input type="hidden" id="businessGroup_code" name="businessGroup_code"> </p>
                            </td>

                        </tr>
                        <tr>
                            <td width="45%">
                                <p class="read">城市名称：<span style="color: red">*</span></p>
                                <p class="read"><select id="citySelect" style="width: 65%" onchange="select_data();"></select><input type="hidden" id="city_name" name="city_name"><input type="hidden" id="city_code" name="city_code"> </p>
                            </td>
                            <td width="45%">
                                <p>毛利：<span style="color: red">*</span></p>
                                <p><input type="text" name="maori_target" id="maori_target" onkeyup="value=value.replace(/[^\d.]/g,'')"/></p>
                            </td>
                        </tr>
                        <tr>
                            <td width="45%">
                                <p class="read">利润：<span style="color: red">*</span></p>
                                <p class="read"><input type="text" onkeyup="value=value.replace(/[^\d.]/g,'')" maxlength="12" name="profit_target" id="profit_target"/></p>
                            </td>
                            <td width="45%">
                                <p>用户：<span style="color: red">*</span></p>
                                <p><input type="text" onkeyup="value=value.replace(/[^\d.]/g,'')" name="user_target" id="user_target"/></p>
                            </td>


                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
    <div id="centerQueryGridContainer" class="panel panel-primary" queryid="targetEntry" operators="$pmspage.opArr"
         titleAlign="center" fnRender="renderColumns" searchDiv="conditionsDiv" showNo="true"
         showsearch="false" showpaging="true" showdisplay="false" showprint="false" autoload="false"
         showcheckbox="false" showRidaoButton="true" usecache="true" showsearch="false" showtitle="true" style="100%"></div>
</body>
</html>