<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>异常订单基础数据</title>
   <link rel="shortcut icon" type="image/x-icon" href="../icon.png" />
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=0.3, maximum-scale=1, user-scalable=yes" name="viewport">  <!-- Bootstrap 3.3.6 -->
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="bootstrap/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="bootstrap/css/ionicons.min.css">
  <!-- Morris charts -->
  <link rel="stylesheet" href="plugins/morris/morris.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="dist/css/skins/_all-skins.min.css">
  <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker-bs3.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="plugins/select2/select2.min.css">
    <link href="../scripts/css/auto.css" rel="stylesheet">
  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="IE 9/html5shiv.min.js"></script>
  <script src="IE 9/respond.min.js"></script>
  <![endif]-->
  <style>
    .box-default{border-bottom: 1px solid #e1e1e1;}
    .info_head{padding: 25px 0 35px 0;}
    .info_head img{width:123px; margin-top:10px;}
    .info_head span{padding-left: 20px;}
    .info_bottom{padding: 35px 20px 0 35px; font-size: 12px;}
    .info_bottom .text-right span{padding: 6px 12px; margin:0 20px 0 3px; display: inline-block;}
    .box .h4{padding-left:20px;}
    .nav-tabs-custom{padding:0 20px;}
    .nav-tabs{border:0;}
    .logo-lg li{float: left; position: relative;}

    .logo-lg i{color: #fff;}
    .nav_dropdown{ position: absolute;z-index: 10000; top: 70px; left: -10px; line-height: 22px; padding: 15px 25px; background-color: #15b092; display: none;}
    .nav_dropdown li{padding: 5px 0; line-height: 20px; white-space: nowrap; font-size: 14px;}
    .logo-lg > ul > li:hover > a{color: #001f3f; font-weight: bold;}
    .logo-lg > ul > li:hover i{ transform: rotate(180deg); transition: all 0.3s linear; color: #001f3f;}
    .table button{padding: 3px 20px; margin: 0 5px;}
	
	.tcdPageCode{padding: 15px 20px;text-align: left;color: #ccc;text-align:center;}
	.tcdPageCode a{display: inline-block;color: #428bca;display: inline-block;height: 25px;	line-height: 25px;	padding: 0 10px;border: 1px solid #ddd;	margin: 0 2px;border-radius: 4px;vertical-align: middle;}
	.tcdPageCode a:hover{text-decoration: none;border: 1px solid #428bca;}
	.tcdPageCode span.current{display: inline-block;height: 25px;line-height: 25px;padding: 0 10px;margin: 0 2px;color: #fff;background-color: #428bca;	border: 1px solid #428bca;border-radius: 4px;vertical-align: middle;}
	.tcdPageCode span.disabled{	display: inline-block;height: 25px;line-height: 25px;padding: 0 10px;margin: 0 2px;	color: #bfbfbf;background: #f2f2f2;border: 1px solid #bfbfbf;border-radius: 4px;vertical-align: middle;}
	.audit_process{ overflow-y: auto;  background: #f9f9f9; border-radius: 5px; padding:15px 0 20px 0;}
    .audit_process .clearfix{ padding:10px 30px;}
    .audit_margin{margin-right: 15px;}
	 #process_div{ 
			background-color:#292a2b; 
			display:inline; 
			z-index:100000;  
			left:0px; 
			opacity:0.3; top:0; left:0;height:100%; width:100%; z-index:999; position:fixed; _position:absolute; _left: expression_r(documentElement.scrollLeft + documentElement.clientWidth - this.offsetWidth); _top: expression_r(documentElement.scrollTop + documentElement.clientHeight - this.offsetHeight);
			filter:Alpha(Opacity=30); 
			opacity: 0.3; 
		} 
		
		#process_div_pic{
			position:fixed;
			top:50%;
			left:50%; 
			z-index:100000000; 
			margin:-16px 0 0 -50px; 
			width:100px; 
			height:32px;
			color: #fff;
		}
    .form-control{height: 30px; line-height: 30px; border-radius: 6px; padding: 3px 8px;}

  </style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div id="process_div" style="display:none"></div>
<div id="process_div_pic" style="display:none"><img style="width:50px;height: 50px;" src="dist/img/376884043677306248.png"><i class="fa fa-refresh fa-spin"></i></div>
<!-- Site wrapper -->
<div class="wrapper">

  <header class="main-header">
    <!-- Logo -->

    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top">
      <!-- Sidebar toggle button-->
      <div class="container">
          <div class="logo_img pull-left">
              <img src="dist/img/logo.png" height="30">
              <img src="dist/img/title.png" height="20">
          </div>
          <div class="pull-left">
              <div class="logo-lg">
                  <ul class="no-margin">
                      <li class="current"><em>异常订单基础数据</em></li>
                  </ul>
              </div>
          </div>
      </div>
    </nav>
  </header>


  <!-- =============================================== -->

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <div class="container">
      <!-- Main content -->

      <section class="content-header">
        <div class="box box-default">
<!--           <div class="box-header h4 text-light-blue"><strong>异常订单基础数据列表</strong> -->
<!--          	<small class="text-red" style="padding-left: 10px;"></small> -->
<!--           </div> -->
          <div class="box-body">
          <form id="can_appeal_form">
          <table style="position:relative;left:60px;width:100%;border-collapse:separate;border-spacing:6px" border="0" cellspacing="3" cellpadding="2" >
          	<tr>
	          	<td><span style="font-weight:700">查询时间</span>：
<!-- 	          		<select class="form-control select2" id="auto_date" > -->
<!-- 		                <option value="prev_month">上月</option> -->
<!-- 		                <option value="cur_month" selected="selected">本月（截止到昨日24点）</option> -->
<!-- 	              	</select> -->
			
                <input type="text" class="form-control pull-right" id="auto_date"  placeholder="点击选择日期" readonly="readonly">
              </div>
	              </td>
	          	<td><span style="font-weight:700">类型</span>：<select class="form-control select2"  id="abnormalType_auto">
	               <option value="" >全部</option>
	              </select></td>
<!-- 	            <td><span style="font-weight:700">状态</span>：<select class="form-control select2"  id="auto_status"> -->
<!-- 	                <option value="" selected="selected">全部</option> -->
<!-- 	                <option value="0">未申诉</option> -->
<!-- 	                <option value="1" >申诉中</option> -->
<!-- 	                <option value="2" >已驳回</option> -->
<!-- 	                <option value="3" >已通过</option> -->
<!-- 	              </select></td> -->
<!-- 	            <td><span style="font-weight:700">产品名</span>：&nbsp; <input type="text" class="form-control"   id="product_auto"/></td> -->
	            <td><span style="font-weight:700">订 单 号</span>：&nbsp; <input type="text" class="form-control"  placeholder="订单号" id="orderSn_auto"/></td>
	            <td><span style="font-weight:700">订单金额</span>：<div style="display:block"><input type="text" class="form-control"  placeholder="最小金额"  id="min_money_auto" style="width:30%;display:inline"/>&nbsp;&nbsp;
	            <input type="text" class="form-control"  placeholder="最大金额"  id="max_money_auto" style="width:30%;display:inline"/></div></td>
           </tr>
           <tr>
	            <td><span style="font-weight:700">城市</span>：
                    <input id="city_id_autoOrder" name="city_id_autoOrder" type="hidden" value=""/>
                    <input type="text" class="form-control"  placeholder="城市" id="city_name_autoOrder" style="display: inherit;width: 100%;border-radius: 6px; box-shadow: 0 1px 1px rgba(0,0,0,0.3)"/>
                    <div class="auto hidden" id="auto_city" style="border:1px solid #dedede;width:23%;left:7px;top:0px;z-index: 99999;">
                        <!-- /.input group -->
                    </div>
                </td>
	            <td><span style="font-weight:700">门店</span>：
                    <input id="store_id_autoOrder" name="store_id_autoOrder" type="hidden" value=""/>
                    <input type="text" class="form-control"  placeholder="门店" id="store_name_autoOrder" style="display: inherit;width: 100%;border-radius: 6px; box-shadow: 0 1px 1px rgba(0,0,0,0.3)"/>
                    <div class="auto hidden" id="auto_store" >
                        <!-- /.input group -->
                    </div>
                </td>
     	    	<td><span style="font-weight:700">事业部</span>：&nbsp; <input type="text" class="form-control"   id="dept_auto"/></td>
     	    	<td><span style="font-weight:700">频道</span>：&nbsp; <input type="text" class="form-control" style="width:64%"  id="channel_auto"/></td>
             </tr>
          	 
          </table>
           </form> 
              <div class="form-group col-lg-6" style="padding-top: 25px;">
              </div>

<!--               <div class=" col-lg-2" style="padding-top: 25px;"> -->
<!--                 <button type="button" style="display:none" id="uploadButton_auto" onclick="showUploadWindow(1)" class="btn btn-block btn-danger">导入</button> -->
<!--               </div> -->
              <div class="form-group col-lg-2" style="padding-top: 25px;">
                <button type="button" onclick="search_auto_abnormalOrder(1)" class="btn btn-block btn-primary">查询</button>
              </div>
            <div class="col-lg-2" style="padding-top: 25px;">
                <button type="button" style="display:inline" id="export_auto_abnormalOrder_button" onclick="export_auto_abnormalOrder()" class="btn btn-block btn-warning">导出</button>
            </div>
               <div class="form-group col-lg-2" style="padding-top: 25px;">
                <button type="button" onclick="resetSerachParam(1)" style="border-color:#00a65a;background-color:#00a652;color:white" class="btn btn-block">重置</button>
              </div>
              
            </div>
			          <div class="box-body">
            <div class="tab-content">
              <table class="table table-striped no-margin">
                <tbody id="auto_tbody">
                <tr id="auto_title">
<!--                   <th width="4%"></th> -->
                  <th width="8%">城市</th>
                  <th width="10%">门店名称</th>
                  <th width="10%">E店名称</th>
                  <th width="10%">事业部</th>
                  <th width="10%">频道</th>
                  <th width="10%">订单号</th>
                  <th width="8%">订单金额</th>
                  <th width="8%">应付金额</th>
                  <th width="8%">异常类型</th>
                  <th width="9%">签收时间</th>
                  <th width="24%">操作</th>
                </tr>
               
                </tbody>
              </table>
              <table class="table table-striped no-margin" id="all_pass_button_can_appeal" style="display:none">
              <tbody>
              <tr style="background: #fff;display:none" id="all_pass_can_appeal">
                  <td style="text-align: left; padding-left: 20px;"><input type="checkbox"  id="all_select_can_appeal">全选</td>
                  <td colspan="9"><button type="button" onclick="orderApprovePass(1)" class="btn btn-primary pull-right">通过</button></td>
                </tr>
                </tbody>
              </tbody>
              </table>
            <!-- /.tab-pane -->
            </div>
            <div class="tcdPageCode" id="page_auto"></div>
          </div>
          </div>

       
        
      </section>
    </div>
  </div>
  <!-- /.content-wrapper -->


</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.0 -->
<script src="plugins/jQuery/jQuery-2.2.0.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="bootstrap/js/bootstrap.min.js"></script>
<!-- Morris.js charts -->
<script src="bootstrap/js/raphael-min.js"></script>
<script src="plugins/morris/morris.min.js"></script>
<!-- FastClick -->
<script src="plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>
<!-- page script -->
<script type="text/javascript" src="plugins/jquery.page.js"></script>
<script type="text/javascript" src="plugins/moment.min.js"></script>
<script type="text/javascript" src="plugins/daterangepicker/daterangepicker.js"></script>
<script type="text/javascript" src="../scripts/bidLibjsjquery3.0.js"></script>
<script type="text/javascript" src="../scripts/auto.js"></script>
<script tyle="text/javascript">
Date.prototype.format=function(fmt) {        
    var o = {        
    "M+" : this.getMonth()+1, //月份        
    "d+" : this.getDate(), //日        
    "h+" : this.getHours()%12 == 0 ? 12 : this.getHours()%12, //小时        
    "H+" : this.getHours(), //小时        
    "m+" : this.getMinutes(), //分        
    "s+" : this.getSeconds(), //秒        
    "q+" : Math.floor((this.getMonth()+3)/3), //季度        
    "S" : this.getMilliseconds() //毫秒        
    };        
    var week = {        
    "0" : "\u65e5",        
    "1" : "\u4e00",        
    "2" : "\u4e8c",        
    "3" : "\u4e09",        
    "4" : "\u56db",        
    "5" : "\u4e94",        
    "6" : "\u516d"       
    };        
    if(/(y+)/.test(fmt)){        
        fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));        
    }        
    if(/(E+)/.test(fmt)){        
        fmt=fmt.replace(RegExp.$1, ((RegExp.$1.length>1) ? (RegExp.$1.length>2 ? "\u661f\u671f" : "\u5468") : "")+week[this.getDay()+""]);        
    }        
    for(var k in o){        
        if(new RegExp("("+ k +")").test(fmt)){        
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));        
        }        
    }        
    return fmt;        
} 


 layer.config({
	
	  extend: 'skin/crmskin/style.css' //加载新皮肤
	  
	});
 
 	var cityId = decode64(getUrlParamByKey("c"));//城市ID
	var employeeId = decode64(getUrlParamByKey("e"));//员工ID
	var storeId = decode64(getUrlParamByKey("s"));//门店ID
	var target = decode64(getUrlParamByKey("t"));//执行人级别 
	var storeName=decode64(getUrlParamByKey("sn"));//门店名称
	var storeno = decode64(getUrlParamByKey("so"));//门店编号
	var role = decode64(getUrlParamByKey("r"));//角色 code
	var cityname = decode64(getUrlParamByKey("cn"));//城市名称
	
  $(function () {
    $(".logo-lg > ul > li").mouseenter(function(){
      $(this).children(".nav_dropdown").show();
    });
    $(".logo-lg > ul > li").mouseleave(function(){
      $(this).children(".nav_dropdown").hide();
    });
    $('#auto_date').daterangepicker();
   
    queryAbnormalOrderType();
//     if(target==1){//订单异常角色组或城市级别
    	
    	
//     	$("#city_manualOrder_div").show();
//     	$("#city_autoOrder_div").show();
//     	if(role=="PTYYZXYCDDZ"){
//     		$("#all_pass_can_appeal").show();
//     		$("#all_pass_cannot_appeal").show();
//         	$("#uploadButton_auto").show();
//         	$("#uploadButton_manual").show();
        	
//         	$("#downOrdersButton").show();
//     		$("#export_auto_abnormalOrder_button").show();
//         	$("#export_manual_abnormalOrder_button").show();
//         	$("#all_pass_button_can_appeal").show();
//         	$("#all_pass_button_cannot_appeal").show();
//         }else{
//         	$("#city_id_manualOrder").val(cityname);
//         	$("#city_name_manualOrder").val(cityname);
//         	$("#city_name_manualOrder").attr("readonly",true);
        	
//         	$("#city_id_autoOrder").val(cityname);
//         	$("#city_name_autoOrder").val(cityname);
//         	$("#city_name_autoOrder").attr("readonly",true);
//         }
//     }else if(target==2){//店长
//     	$("#tianchong").attr("class","col-lg-6")
// 		$("#store_name_autoOrder").val(storeName);
// 		$("#store_name_autoOrder").attr("readonly",true);
		
// 		$("#store_name_handOrder").val(storeName);
// 		$("#store_name_handOrder").attr("readonly",true);
		
		
// 		$("#city_id_manualOrder").val("");
//     	$("#city_name_manualOrder").val("");
//     	$("#city_id_autoOrder").val("");
//     	$("#city_name_autoOrder").val("");
    	
//     }
    
    
  });
	
	
	$("#all_select_can_appeal").on("click",function(t,tt){
		if($("#all_select_can_appeal").is(":checked")){
			$("input[id^='can_appeal_checkbox_']:not(:disabled)").each(function(i,t){
				$(t)[0].checked=true;
			})
		}else{
			$("input[id^='can_appeal_checkbox_']").each(function(i,t){
				$(t)[0].checked=false;
			})
		}
	})
	
	$("#all_select_cannot_appeal").on("click",function(t,tt){
		if($("#all_select_cannot_appeal").is(":checked")){
			$("input[id^='cannot_appeal_checkbox_']:not(:disabled)").each(function(i,t){
				$(t)[0].checked=true;
			})
		}else{
			$("input[id^='cannot_appeal_checkbox_']").each(function(i,t){
				$(t)[0].checked=false;
			})
		}
	})
	
	function selectCheckbox(t,t1){
		if(t1==1){
			
			if($(t).is(":checked")){
				
				var validc = $("input[id^='can_appeal_checkbox_']:not(:disabled)").length;
				var checkedc = $("input[id^='can_appeal_checkbox_']:checked").length;
				
				if(validc==checkedc){
					
					$("#all_select_can_appeal")[0].checked=true;
				}else{
					
					$("#all_select_can_appeal")[0].checked=false;
				}
			}else{
				
				$("#all_select_can_appeal")[0].checked=false;
			}
		}else if(t1==2){
			if($(t).is(":checked")){
				
				var validc = $("input[id^='cannot_appeal_checkbox_']:not(:disabled)").length;
				var checkedc = $("input[id^='cannot_appeal_checkbox_']:checked").length;
				
				if(validc==checkedc){
					
					$("#all_select_cannot_appeal")[0].checked=true;
				}else{
					
					$("#all_select_cannot_appeal")[0].checked=false;
				}
			}else{
				
				$("#all_select_cannot_appeal")[0].checked=false;
			}
			
		}
		
		
	}
	
	
	//通过
	function orderApprovePass(t){
		
		layer.confirm('是否继续通过？', {
		  	title:'提示',
		  	offset:['100px','550px'],
		  	move:false,
		  	closeBtn:0,
		  	skin:'layer-ext-crmskin',
			btn: ['继续','取消'], //按钮
		}, function(){
			layer.closeAll();
			var orderIDs = [];
			if(t==1){//可申诉
				$("input[id^='can_appeal_checkbox_']").each(function(i,t){
					var orderId = $(t)[0].id.split("_")[4];
					var status = $(t)[0].id.split("_")[3];
					if((status=="0"||status=="2")&&$(t).is(":checked")){
						
						orderIDs.push(orderId);
					}
					
				})
			}else if(t==2){//不可申诉
				$("input[id^='cannot_appeal_checkbox_']").each(function(i,t){
					var orderId = $(t)[0].id.split("_")[4];
					var status = $(t)[0].id.split("_")[3];
					if(status=="0"&&$(t).is(":checked")){
						
						orderIDs.push(orderId);
					}
					
				})
			}
			
			
		
			if(orderIDs.length==0){
				crm_alert(0,"请选择未申诉订单！");
				return;
			}
			
			  doManager('dsAbnormalOrderManager','updateDsAbnormalTypeBySN',[orderIDs.join()],function(data){
		          if(data.result){
		          	
		          	 var result = JSON.parse(data.data);
		          	
		             if(result.status=="success"){
		            	 if(t==1){
		            		 search_auto_abnormalOrder(1);
		            	 }else if(t==2){
		            		 search_manual_abnormalOrder(1)
		            	 }
		            	
		             }else{
		            	 crm_alert(0,"订单未成功通过！");
		             }
		          }else{
		        	  crm_alert(0,"订单未成功通过！");
		          }
		      });
		});
		
		
		  
	}
	
	function queryAbnormalOrderType(t){
		  doManager('dynamicManager','queryAbnormalOrderType',null,function(data){
	          if(data.result){
	          	
	          	  var lst_select_abnormaltype = JSON.parse(data.data);
	              $(lst_select_abnormaltype).each(function(index,element){
	            	  if(element.datatype=="manual"){
	                      $('#abnormalType_auto').append('<option value="'+element.description+'">'+element.description+'</option>');

	            	  }
	              });
	          }else{
	          	
	          }
	      });
	  }
  
  
  /**--------------------------------自动搜索城市---------------------------------------------------------------**/
  var lst_select_city1=null;
  var cityNameArray=new Array();
  var cityIdMap = {};
  var cityNameIdMap={};
  $('#city_name_autoOrder').keyup(function(event){

        var str_name = $(this).val();
        if(!(event.keyCode >= 37 && event.keyCode <= 40) && event.keyCode != 13){
        	$("#city_id_autoOrder").val("");
            $("#store_id_autoOrder").val("");
            $("#store_name_autoOrder").val("");
            $("#auto_city").empty();
            $("#auto_store").empty();
            if(str_name == null || str_name == "" || str_name.indexOf('\'') > -1){
                return;
            }
          
            doManager('dynamicManager','getCityByUser',[1,employeeId,str_name],function(data){
                if(data.result){
                	
                	lst_select_city1 = JSON.parse(data.data);
                	
                    $(lst_select_city1).each(function(index,element){

                        cityNameArray.push(lst_select_city1[index].name);
                        cityIdMap[lst_select_city1[index].name] = lst_select_city1[index].name;
                        cityNameIdMap[lst_select_city1[index].name] = lst_select_city1[index].ctid;

                    });
                    var autoComplete = new AutoComplete("city_name_autoOrder","auto_city",cityNameArray);
                    autoComplete.start(event);
                    $("#auto_city").attr("style","width:25.7%;z-index:999999");
                }else{
                	
                }
            });
        }
    });

    $('#auto_city').on("click",function(){
         var temp_city = document.getElementById("city_name_autoOrder").value.replace(/(\s*)|(\s*)/g,'').replace(/[ ]/g,'');
         $("#city_id_autoOrder").val(cityIdMap[temp_city]);
    });

     
     
  
  
  /**-----------------------------------自动异常订单搜索门店------------------------------------------------------**/
  var lst_select_store1=null;
  var storeNameArray=new Array();
  var storeIdMap = {};
  $('#store_name_autoOrder').keyup(function(event){
      $("#auto_store").empty();
        var str_name = $(this).val();
        if(!(event.keyCode >= 37 && event.keyCode <= 40) && event.keyCode != 13){
        	$("#store_id_autoOrder").val("");

            if(str_name == null || str_name == "" || str_name.indexOf('\'') > -1){
                return;
            }
            var city_name = $("#city_id_autoOrder").val();
            var city_id = null;
            if(city_name!=""){
                city_id = cityNameIdMap[city_name];
                if(city_id==null){
                    city_id=-1000;
                }
            }


            doManager('dynamicManager','getStoreByCity',[1,employeeId,city_id,str_name],function(data){
                if(data.result){
                	
                	lst_select_store1 = JSON.parse(data.data).storelist;
                    $(lst_select_store1).each(function(index,element){

                        storeNameArray.push(lst_select_store1[index].name);
                        storeIdMap[lst_select_store1[index].name] = lst_select_store1[index].storeno;
                    });
                    var autoComplete = new AutoComplete("store_name_autoOrder","auto_store",storeNameArray);
                    autoComplete.start(event);
                    $("#auto_store").attr("style","width:17.5%;z-index:999999");
                }else{
                	
                }
            });
        }
    });

     $('#auto_store').on("click",function(){

         var temp_store = document.getElementById("store_name_autoOrder").value.replace(/(\s*)|(\s*)/g,'').replace(/[ ]/g,'');
         $("#store_id_autoOrder").val(storeIdMap[temp_store]);
    }); 
     
     

     
     
  
  //导出基础异常订单
  function export_auto_abnormalOrder(){
	  var sdate = $("#auto_date").val();
	  var begin_end_date=["",""];
	  	if(sdate!=""){
	  		 begin_end_date = sdate.split("-");
	   	}
	  	
	    $("#process_div").show();
	 	$("#process_div_pic").show();
	 	var number_str = $("#store_id_autoOrder").val(); 
  	    var storeName = $("#store_name_autoOrder").val();
  	   
  	    var city=$("#city_id_autoOrder").val();
	    var city_name=$("#city_name_autoOrder").val();
	    if(number_str==""&&storeName!=""){
	    	number_str=-10000;
	    }
	    
	    if(city==""&&city_name!=""){
	    	city="-10000";
	    }
	  
	    var type = $("#abnormalType_auto").val();
	    var ordersn = $("#orderSn_auto").val();
	    var dept = $("#dept_auto").val();
	    var channel = $("#channel_auto").val();
	    var min_money_auto = $("#min_money_auto").val();
	    var max_money_auto = $("#max_money_auto").val();
	    var abnormalOrderDto=null;
	 
	   abnormalOrderDto = {
		    beginDate:begin_end_date[0].trim(),
		    endDate:begin_end_date[1].trim(),
			ordersn:ordersn,
			abnortype:type,
	  		storeno:number_str,
	  		cityname:city,
	  		dept:dept,
	  		channel:channel,
	  		minPrice:min_money_auto,
	  		maxPrice:max_money_auto
		}

	   
	  
	    doManager('dsAbnormalOrderManager','exportBaseAbnormalOrder',[abnormalOrderDto],function(data){
	          if(data.result){
	          	   var result= JSON.parse(data.data);
		           if(result.status=='success'){
		        	   window.location.href=result.data;
		           }else{
		        	   crm_alert(0,"请先确认是否有符合条件的数据，重新请求！");
		        	   $("#process_div").hide();
	        	       $("#process_div_pic").hide();
		        	   return;
		           }
	          
	          }else{
	       	   crm_alert(5,"请稍后重新请求！");
	          }
	         $("#process_div").hide();
	    	 $("#process_div_pic").hide();
	     });
  }
  
  
   var isCreatePage=false;
   function search_auto_abnormalOrder(cur_page){
  		isCreatePage=false;
  		
  		search_auto_abnormalOrder1(cur_page);
   }
  
  //查询基础异常订单
  var currentPage_auto= 1;
  var totalPage_auto = 1;
  function   search_auto_abnormalOrder1(cur_page){
	  $("#all_select_auto").attr("checked",false);
	    var sdate = $("#auto_date").val();
	   
	    var begin_end_date=["",""];
	  	if(sdate!=""){
	  		 begin_end_date = sdate.split("-");
	   	}
	  	
  	    $("#process_div").show();
 	 	$("#process_div_pic").show();
  	
 	 	
 	 	var number_str = $("#store_id_autoOrder").val(); 
  	    var storeName = $("#store_name_autoOrder").val();
  	  
  	    var city=$("#city_id_autoOrder").val();
  	    var city_name=$("#city_name_autoOrder").val();
  	 
  	    if(number_str==""&&storeName!=""){
  	    	number_str=-10000;
  	    }
  	    
  	    if(city==""&&city_name!=""){
  	    	city="-10000";
  	    }
  	   
	   
	    var type = $("#abnormalType_auto").val();
	    var ordersn = $("#orderSn_auto").val();
	   
	    var dept = $("#dept_auto").val();
	    var channel = $("#channel_auto").val();
	    var min_money_auto = $("#min_money_auto").val();
	    var max_money_auto = $("#max_money_auto").val();
	    var abnormalOrderDto=null;
	  
		   abnormalOrderDto = {
				beginDate:begin_end_date[0].trim(),
			    endDate:begin_end_date[1].trim(),
				ordersn:ordersn,
				abnortype:type,
		  		storeno:number_str,
		  		cityname:city,
		  		dept:dept,
		  		channel:channel,
		  		minPrice:min_money_auto,
		  		maxPrice:max_money_auto
			}
	    
	    var pageInfo = new Object();
	    pageInfo.currentPage = cur_page;
	    
	    doManager('dsAbnormalOrderManager','queryBaseAbnormalOrder',[abnormalOrderDto,pageInfo],function(data){
         if(data.result){
         	   var result= JSON.parse(data.data);
	           if(result.status=='success'){
	        	   $("#auto_tbody").find("tr:gt(0)").remove(); 
	        	   var jData = result.data;
	        	   if(jData==null||jData.length==0){
	        		   crm_alert(5,"系统查无此条件的数据");
	        		   $("#page_auto").createPage({
	        	 	  	    pageCount:0,
	        	 	  	    current:0,
	        	 	  	    backFn:function(p){
	        	 	  	    	
	        	 	  	    }
	        	 	  	});
	        		   $("#process_div").hide();
	        	       $("#process_div_pic").hide();
	        		   return;
	        	   }
	        	   totalPage_auto = result.total_pages;
	        	   if(!isCreatePage){
	        		   $("#page_auto").createPage({
	        	 	  	    pageCount:totalPage_auto,
	        	 	  	    current:1,
	        	 	  	    backFn:function(p){
	        	 	  	    	search_auto_abnormalOrder1(p);
	        	 	  	    }
	        	 	  	});
	        		   isCreatePage=true;
	        	   }
	        	  
	        	   var infoStr="";
	        	   for(var i=0;i<jData.length;i++){
	        		  
	        		   infoStr= "<tr>";
// 	        			    if(role=="PTYYZXYCDDZ"){//异常订单管理者
// 	        			    	if(jData[i].status==0||jData[i].status==2){
// 		        			    	infoStr  = infoStr+"<td style=\"text-align: left; padding-left: 20px;\"><input id=\"can_appeal_checkbox_"+jData[i].status+"_"+jData[i].id+"\" onclick=\"selectCheckbox(this,1)\" type=\"checkbox\"></td>";
// 	        			    	}else{
// 		        			    	infoStr  = infoStr+"<td style=\"text-align: left; padding-left: 20px;\"><input id=\"can_appeal_checkbox_"+jData[i].status+"_"+jData[i].id+"\" disabled=\"disabled\" type=\"checkbox\"></td>";
// 	        			    	}
// 	        		   		}else{
//	        			    	infoStr  = infoStr+"<td style=\"text-align: left; padding-left: 20px;\"></td>";
// 	        		   		}
	        		   		
        			       var s="";
        			       if(jData[i].signedtime!=null){
        			    		var d=	new Date();
        			     		d.setTime(jData[i].signedtime);
        			   		 	s=d.format('yyyy-MM-dd HH:mm:ss')
        			       }
        			      
	        			    infoStr = infoStr
	        			       +"<td>"+jData[i].cityname+"</td>"
		                       +"<td>"+jData[i].storename+"</td>"
		                       +"<td>"+(jData[i].eshopname==null?'':jData[i].eshopname)+"</td>"
		                       +"<td>"+jData[i].deptname+"</td>"
		                       +"<td>"+jData[i].channelname+"</td>"
		                       +"<td>"+jData[i].ordersn+"</td>"
		                       +"<td>"+jData[i].tradingprice+"</td>"
		                       +"<td>"+(jData[i].payableprice==null?'':jData[i].payableprice)+"</td>"
		                       +"<td>"+jData[i].description+"</td>"
		                       +"<td>"+s+"</td>"
		                       +"<td><button type=\"button\" onclick=\"showorderdetail('"+jData[i].ordersn+"')\" class=\"btn btn-default\">订单详情</button>";
		                       
		                       if(target==2){//角色是店长
		                    	  if(jData[i].status==0||jData[i].status==2){
			                    	   infoStr = infoStr+"<button type=\"button\" onclick=\"gotoAppeal('"+jData[i].ordersn+"',"+jData[i].status+")\" class=\"btn btn-danger\">申诉</button></td>"
		                    	  }else{
		                    		  infoStr = infoStr+"<button type=\"button\" disabled=\"disabled\" class=\"btn btn-danger\">申诉</button></td>";
		                    	  }
		                       }
		                       
		                       infoStr = infoStr+"</tr>";
		                       
		                  $("#auto_tbody").append(infoStr);     
	        	   }
	           }else{
	        	   crm_alert(5,"请稍后重新请求！");
	        	   return;
	           }
         
         }else{
      	   crm_alert(5,"请稍后重新请求！");
         }
        $("#process_div").hide();
   	    $("#process_div_pic").hide();
     }); 
  	   
  }
  
  
  









  var source_upload_type="manual_can_appeal";
  function showUploadWindow(t){
	  if(t==1){
		  source_upload_type="manual_can_appeal"
	  }else if(t==2){
		  source_upload_type="manual_cannot_appeal"
	  }
	  
	  layer.open({
		  type: 1,
   		  title:  ["导入异常订单", 'color:#fff'],
   		  shadeClose: true,
   		  shade:[0.1, '#393D49'],
   		  moveOut:false,
   		  skin: 'layer-ext-crmskin',
   		  area: ['400px','100px'],
   		  offset: ['200px','530px'],
   		  content:$("#abnormalOrderDiv"),
   		  success:function(layer,index){
   			 $("#layui-layer-iframe1").attr("style","width:50px");
   		  },
   		  cancel: function(index, layero){ 
   			 layer.close(index);
   			}  
   		});  
  }
  
  function isnull(str) {
      return str == null || str == "null" || str == "" || str == "undefined" || typeof(str) == "undefined";
  }
  
  function uploadAbnormalOrderExcel(){
		$('button[name="uploadAbnormalOrder"]').attr("disabled",true);
        var content = $('input[name="fileorder"]').val();
       
        //文件不能为空
        if (isnull(content)) {
        	crm_alert(0,"请选择文件");
            $('button[name="uploadAbnormalOrder"]').attr("disabled",false);
            return false;
        }
        //后缀必须为xls,不支持2007
        var suffix = content.match(/^(.*)(\.)(.{1,8})$/)[3];
        if ("xls" != suffix ) {
        	crm_alert(0,"请上传xls文件");
            $('button[name="uploadAbnormalOrder"]').attr("disabled",false);
            return false;
        }
        layer.closeAll();
        var path = getRootPath();
        var $form_upload = $("#uploadOrderForm");
        $form_upload.attr("action", path + "/uploadOrderExcel.action?dataType="+source_upload_type);
        $form_upload.submit();
        $('button[name="uploadAbnormalOrder"]').attr("disabled",false);
        $('input[name="fileorder"]').val('');
        
        $("#process_div").show();
	    $("#process_div_pic").show();
  }
  
 
  
  function showUploadResult(info){
	  $("#process_div").hide();
      $("#process_div_pic").hide();
	  $('input[name="fileorder"]').val('');
	  layer.closeAll();
	  if(info=="sucess"){
		  crm_alert(6,"上传成功");
	  }else{
		  crm_alert(5,info);
	  }
	  
  }
  
  
  function showorderdetail (order_sn){
// 	  doManager('dynamicManager','checkOrderExist',[order_sn],function(data){
//           if(data.result){
//           	   var result= JSON.parse(data.data);
//           	   alert(result)
// 	           if(result=='Y'){
	        	 
// 	           }else{
// 	        	   crm_alert(0,"该订单号不存在!");
// 	           }
//           }
//      });
	  
	  $("#process_div").show();
  	  $("#process_div_pic").show();
	  var url = "order_detail_alert.html?order_sn="+encode64(order_sn);
		 //window.location.href=url;
		 layer.open({
		  type: 2,
  		  title:  ['订单信息', 'color:#fff'],
  		  shadeClose: true,
  		  shade:[0.1, '#393D49'],
  		  moveOut:false,
  		  move:false, 
  		  skin: 'layer-ext-crmskin',
  		  area: ['90%', '88%'],
  		  offset: ['2px','65px'],
  		  content: url,
  		  success:function(layer,index){
  			  $("#process_div").hide();
  		      $("#process_div_pic").hide();
  			 //$("#layui-layer-iframe1").attr("style","height:200px");
  		  },
  		  cancel: function(index, layero){ 
  			 layer.close(index);
  			}  
  		});  
	    
  }
  
  
  
  function showTaskDetail(sn){
	  $("#process_div").show();
  	  $("#process_div_pic").show();
	  doManager('FlowDetailManager','queryAllFlowDetailByOrderSN',[sn],function(data){
		   if(data.result){
			   $("#taskDetailDiv").empty();
		   	  var result= JSON.parse(data.data);
		   	  var flowStr="";
		   	  if(result!=null){
		   	   	  for(var i=0;i<result.length;i++){
				   		flowStr = "<div class=\"clearfix\">"+
				        	"<div class=\"pull-left audit_margin\"><strong>"+result[i].create_user+"</strong></div>"+
				        	"<div class=\"pull-left\"><span class=\"margin-r-5\">"+result[i].update_user+"</span>"+result[i].approv_ret+"</div>"+
				        	"<div class=\"col-lg-12 no-padding\">"+result[i].approv_content+"</div>"+
				      		"</div>";
				   		  $("#taskDetailDiv").append(flowStr);
				   	  }
				   	  
				   	layer.open({
						  type: 1,
				  		  title:  ['审批过程', 'color:#fff'],
				  		  shadeClose: true,
				  		  shade:[0.1, '#393D49'],
				  		  moveOut:false,
				  		  move:false, 
				  		  skin: 'layer-ext-crmskin',
				  		  area: ['45%', '69%'],
				  		  offset: ['10%','30%'],
				  		  content: $("#taskDetailDiv"),
				  		  success:function(layer,index){
				  			  $("#process_div").hide();
				  		  	  $("#process_div_pic").hide();
				  			  $("#layui-layer-iframe1").attr("style","height:200px");
				  		  },
				  		  cancel: function(index, layero){ 
				  			 layer.close(index);
				  			}  
				  		}); 
		   	  }else{
		   		 
		   		 $("#process_div").hide();
	  		  	 $("#process_div_pic").hide();
	  		  	 crm_alert(5,"没有审批过程！");
		   	  }
		
		   }
	  });
  }
  
  function  gotoAppeal(ordersn,status){
	  
	  var url = "appeal_detail.html?order_sn="+ encode64(ordersn)+"&storeno="+encode64(storeno)+"&status="+encode64(status)+"&storename="+encode64(storeName);
	  window.open(url,"order_"+ordersn);
		  
  }
  //从订单库下载异常订单
  function downAbnormalOrders(){
	 
	  	
	    $("#process_div").show();
	 	$("#process_div_pic").show();
	 	var number_str = $("#store_id_handOrder").val(); 
	    var storeName = $("#store_name_handOrder").val();
	    if(number_str==""&&storeName!=""){
	    	number_str=-10000;
	    }
	   
	    var status = $("#manual_status").val(); 
	    var type = $("#abnormalType_manual").val();
	    var ordersn = $("#orderSn_manual").val();
	    var abnormalOrderDto=null;
	   if(target==1){
		   abnormalOrderDto = {
				sDate:sdate,
				ordersn:ordersn,
				abnortype:type,
				status:status,
		  		target:target,
		  		datatype:"manual",
		  		storeno:number_str
			}
	    }else if(target==2){
	    	 abnormalOrderDto = {
	 				sDate:sdate,
	 				ordersn:ordersn,
	 				abnortype:type,
	 				status:status,
	 		  		target:target,
	 		  		storeno:storeno,
	 		  		datatype:"manual"
	 			}
	    }
	   
	  
	    doManager('DsAbnormalOrderManager','downAbnormalOrders',[abnormalOrderDto],function(data){
	          if(data.result){
	          	   var result= JSON.parse(data.data);
		           if(result.status=='success'){
		        	   window.location.href=result.data;
		           }else{
		        	   crm_alert(0,"请先确认是否有符合条件的数据，重新请求！");
		        	   $("#process_div").hide();
	        	       $("#process_div_pic").hide();
		        	   return;
		           }
	          
	          }else{
	       	   crm_alert(5,"请稍后重新请求！");
	          }
	         $("#process_div").hide();
	    	 $("#process_div_pic").hide();
	     });
	  
  }
  
  
  function resetSerachParam(t){
	  if(t==1){//可申诉
		  document.getElementById("can_appeal_form").reset(); 
	  	  $("#city_id_autoOrder").val("");
	  	  $("#store_id_autoOrder").val("");
	  }else if(t==2){//不可申诉
		  document.getElementById("cannot_appeal_form").reset(); 
		  $("#city_id_manualOrder").val("");
	  	  $("#store_id_handOrder").val("");
	  }
  }
</script>
</body>
<div id="abnormalOrderDiv" style="width:320px;height:40px;display:none">
 <form action="uploaderAction.action" method="post" enctype="multipart/form-data" id="uploadOrderForm" target="t_f_a_o" style="width:110%; float:left;">
	<table style="margin:10px 10px 10px 60px">
		<tr>
			<td>
			<input type="file" isuploadtable="true" name="fileorder" class="form-control" style="height:35px;">
		   </td>
		   <td>
		    <span class="input-group-btn" style="width:10%; display:inline-block;">
		         <button type="button" class="btn btn-default" onclick="uploadAbnormalOrderExcel();" name="uploadAbnormalOrder">
		             <img src="../scripts/images/upload_to_cloud.png" alt="" style="height: 20px"/>
		         </button>
		     </span>
			</td>
		</tr>
	</table>
	 <iframe name="t_f_a_o" id="t_f_a_o" style="display: none"></iframe>
  	</form>
</div>

 <div class="audit_process" id="taskDetailDiv" style="display:none">
 </div>
</html>