<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>片区范围</title>
    <link rel="shortcut icon" type="image/x-icon" href="../icon.png" />
    <link rel="stylesheet" href="https://cache.amap.com/lbs/static/main1119.css"/>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="bootstrap/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="bootstrap/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="../data_access/dist/css/skins/_all-skins.min.css">
    <script src="https://webapi.amap.com/maps?v=1.4.2&key=f52a1bb11408e8a46dc884b2aaa44edc&plugin=AMap.PolyEditor,AMap.CircleEditor"></script>
    <script type="text/javascript" src="../scripts/custom_color.js"></script>
    <!-- <script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script> -->
    <style type="text/css">
        *{margin: 0; padding: 0;}
	ul,li{list-style: none;}
	 body {
		margin: 0;
		height: 100%;
		width: 100%;
		position: absolute;
		font-size: 12px;
	}

	#mapContainer {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
	}

	input[type="text"] {
		height: 25px;
		outline: none;
		border: 0;
		border: 1px solid #CCCCCC;
		padding: 0 4px;
	}

	.button-group {
		position: absolute;
		/* top: 20px; */
		right: 20px;
		font-size: 12px;
		padding: 10px;
	}

	.content-header{padding-top: 0;}
    .form-group{line-height: 34px;}
   	.form-group label{font-size: 12px; margin: 0; display: block; height: 30px;}

	.menu{position: absolute; top: 50px;  left: 20px; width: 350px;}
    .sidebar-form{position: fixed; width: 350px; height: 43px; line-height: 40px; background-color: #fff; box-shadow: 1px 2px 1px rgba(0,0,0,.15); border: 0!important;}
    .menu_list{margin: 55px 0 0 0; width: 350px; background-color: #fff; overflow: hidden; padding-top: 15px!important; box-shadow: 1px 2px 1px rgba(0,0,0,.15);-webkit-transition: all .3s ease-in-out;-o-transition: all .3s ease-in-out;transition: all .3s ease-in-out}
	.menu_list ul{overflow-y: auto;}
	.menu_list ul::-webkit-scrollbar{width: 8px; background-color: #fff;}
    .menu_list ul::-webkit-scrollbar-thumb{background-color: #adadad; border-radius: 5px;}
    .menu_list ul::-webkit-scrollbar-track{background-color: #fff;}
	.menu_list li{width: 316px; line-height: 22px; padding: 5px 8px 15px 8px; margin: 0 10px 0 15px; border-bottom: 1px solid #eaeaea; font-size: 12px; overflow: hidden;}
	.menu_list li:nth-last-child(1){border: none;}
	/*.menu_list li span{color: #0a67f2; font-weight: bold; font-size: 16px; padding-right: 5px;}*/
	.menu_list li p:nth-child(1){padding-bottom: 7px; font-size: 14px; color: #333;}
	p{margin: 0;}
	.menu_list li a{color: #999; display: inline-block; width: 100%; text-decoration: none; padding-top: 5px;}
	.menu_list li:hover,.menu_list li:visited,.menu_mark{background-color: rgba(0,0,0,0.05);}
	.result_hide{padding: 10px 0 10px 0;margin: 55px 0 0 0; width: 349px; background-color: #fff; color: #3385ff; text-align: center; font-size: 14px; -webkit-transition: all .3s ease-in-out;-o-transition: all .3s ease-in-out;transition: all .3s ease-in-out}
	.btn-style{height: 28px;line-height: 28px;color: #FFF;border: 0;outline: none;padding-left: 5px;padding-right: 5px;border-radius: 3px;margin-bottom: 4px;cursor: pointer;}
	.btn-blue{background-color: #0D9BF2;}
	.btn-gray{background-color: #bcbcbc;}
	.amap-maptype-list{display: none!important;}

	.no-padding{padding: 0;}
	.menu_list .col-lg-4 p{width: 50px; height: 50px; margin: 10px auto 0 auto; background-color: #00a7d0}
	.col-lg-8{width: 66%; float: left;}
	.col-lg-4{width: 34%; float: left;}
	
	 .marker-route {
          position: absolute;
          padding: 5px 10px;
          color: #e90000;
          background:#4598e0;
          cursor: pointer;
          white-space:nowrap;
          position: relative;
          color: #fff;
          border-radius: 3px;
          font-size:14px;
        }
     .marker-route:after {
       	content:'';
        position: absolute;
       	width: 0;
	    height: 0;
	    border-left: 5px solid transparent;
	    border-right: 5px solid transparent;
	    border-top: 6px solid #4598e0;
      	bottom: -6px;
       	left:50%;
       	margin-left:-5px;
      }
      
      #process_div{ 
		background-color:#292a2b; 
		display:inline; 
		z-index:100000;  
		left:0px; 
		opacity:0.3; top:0; left:0;height:100%; width:100%; z-index:999; position:fixed; _position:absolute; _left: expression_r(documentElement.scrollLeft + documentElement.clientWidth - this.offsetWidth); _top: expression_r(documentElement.scrollTop + documentElement.clientHeight - this.offsetHeight);
		filter:Alpha(Opacity=30); 
		opacity: 0.3; 
	} 
	
	#process_div_pic{
		position:fixed;
		top:50%;
		left:50%; 
		z-index:100000000; 
		margin:-16px 0 0 -50px; 
		width:100px; 
		height:32px;
		color: #fff;
	}
	/*全屏按钮*/
    .pull-right-fullscreen {
    	position:absolute;
    	z-index:10;
    	right:20px;
    }
    /*全屏样式*/
    #mask{width:100%; height:100%; position:fixed; top:0; left:0; display: none; z-index:9999999; background-color: rgba(0,0,0,0.7);}
    #mask-body{ position: absolute; top: 50px; left: 50px; height: 600px; opacity: 1; z-index: 99; }
    #mask-header{ position: absolute; top: 50px; left: 0px; height: 50px; opacity: 1; z-index: 999; }
    #mask-header>button{ padding: 3px 5px;  position: absolute; left: 15px; top: -45px; cursor: pointer; }
    </style>
</head>
<body class="skin-blue">
<div class="wrapper" style="background-color: #f1f1f1;">
<!-- Content Wrapper. Contains page content -->
  <div id="process_div" ></div>
  <div id="process_div_pic" ><img style="width:50px;height: 50px;" src="dist/img/376884043677306248.png"><i class="fa fa-refresh fa-spin"></i></div>
      <!-- Main content -->
      <section >
       
        <div  style="position:relative" id="mapHeight">
          <div id="mapContainer" style="background-color:rgba(0,0,0,0.5)"></div>
		  <!--左侧列表-->
		  <div class="menu">
		    <div class="sidebar-form">
		        <div class="input-group">
		            <input id="search" type="text" name="q"   class="form-control" placeholder="搜索">
		            <span class="input-group-btn">
		                <button onClick="cleanSearch()" class="btn btn-flat"><i class="fa fa-remove" style="color: #bbc0c2; font-weight: normal;"></i></button>
		            </span>
		        </div>
		    </div>
		    <div class="menu_list" id="test">
			   <ul id="tinyvillage_ul" style="max-height: 500px;">   
			   </ul>
			</div>
		  </div>
		  <!--左侧列表-->
        </div>
	  </section>
  <!-- /.content-wrapper -->
</div>

<!-- jQuery 2.2.0 -->
<script src="../crm/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="../crm/bootstrap/js/bootstrap.min.js"></script>
<!-- Morris.js charts -->
<script src="../crm/bootstrap/js/raphael-min.js"></script>
<!-- FastClick -->
<script src="../crm/plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="../crm/dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="../crm/dist/js/demo.js"></script>
<script type="text/javascript" src="../scripts/bidLibjsjquery3.0.js"></script>

<script type="text/javascript" src="../scripts/custom_color.js"></script>
<script type="text/javascript">
    var windowHeight = 0;
    var windowWidth = 0;
    autodivheight();
    function autodivheight(){ //函数：获取尺寸
        //获取浏览器窗口高度
        var winHeight=0;
        if (window.innerHeight){
            winHeight = window.innerHeight;
            windowHeight = window.innerHeight;
            windowWidth = window.innerWidth;
        }else if ((document.body) && (document.body.clientHeight)){
            winHeight = document.body.clientHeight;
        	windowHeight = document.body.clientHeight;
        	windowWidth = document.body.clientWidth;
        //通过深入Document内部对body进行检测，获取浏览器窗口高度
        }else if (document.documentElement && document.documentElement.clientHeight){
            winHeight = document.documentElement.clientHeight;
        
        	windowHeight = document.documentElement.clientHeight;
    		windowWidth = document.documentElement.clientWidth;
	        //DIV高度为浏览器窗口的高度
	        //document.getElementById("test").style.height= winHeight +"px";
	        //DIV高度为浏览器窗口高度的一半
	        document.getElementById("tinyvillage_ul").style.maxHeight= winHeight - 200 +"px";
    	}
    }
    window.onresize=autodivheight; //浏览器窗口发生变化时同时变化DIV高度
</script>
<script type="text/javascript">
    automapheight();
    function automapheight(){ //函数：获取尺寸
        //获取浏览器窗口高度
        var winHeight=0;
        if (window.innerHeight)
            winHeight = window.innerHeight;
        else if ((document.body) && (document.body.clientHeight))
            winHeight = document.body.clientHeight;
        //通过深入Document内部对body进行检测，获取浏览器窗口高度
        if (document.documentElement && document.documentElement.clientHeight)
            winHeight = document.documentElement.clientHeight;
        //DIV高度为浏览器窗口的高度
        //document.getElementById("test").style.height= winHeight +"px";
        //DIV高度为浏览器窗口高度的一半
        document.getElementById("mapHeight").style.height= winHeight+"px";
    }
    window.onresize=autodivheight; //浏览器窗口发生变化时同时变化DIV高度
</script>
<script type="text/javascript">
    
    //保存时存放area的数组
    var storeId = decode64(getUrlParamByKey("sid"));//门店ID
    var cityId = getUrlParamByKey("ci");//城市Id
    var areaNo = decode64(getUrlParamByKey("ao"));//片区编号
    var areaId = decode64(getUrlParamByKey("ai"));//片区ID
    var tinyVillageId = decode64(getUrlParamByKey("tid"));//小区ID
    var tinyvillageName = decode64(getUrlParamByKey("tv"));//小区名称
    $("#search").val(tinyvillageName);
    //该数组用于该小区操作坐标
    var polygonArray = [];
    var polygonArrayCopy = [];
    //服务区域
    var polygonArea = [];
    //存放所有小区的数组
    var tinyAreaArray = [];//小区区域数组
    var lastIdx;
    var storeno="";
    var isDrawing = false;

    const POLYGON_STATE_DRAW = 0;
    const POLYGON_STATE_DRAW_EDIT = 1;
    const POLYGON_STATE_UPDATE_EDIT = 2;
    const POLYGON_STATE_RECORDED = 3;
    

    //初始化地图对象，加载地图
    var map = new AMap.Map("mapContainer", {
        resizeEnable : true,
        zoom : 15
    });


    map.plugin(["AMap.ToolBar"],function(){
        //加载工具条
        var toolBaropt = {
            offset :new AMap.Pixel(20,55),//相对于地图容器左上角的偏移量，正数代表向右下偏移。默认为AMap.Pixel(10,10)
            /*
             *控件停靠位置
             *LT:左上角;
             *RT:右上角;
             *LB:左下角;
             *RB:右下角;
             *默认位置：LT
             */
            position : 'RT',
            ruler : true,//标尺键盘是否可见，默认为true
            noIpLocate : false,//定位失败后，是否开启IP定位，默认为false
            locate : true,//是否显示定位按钮，默认为false
            liteStyle : false,//是否使用精简模式，默认为false
            direction : true,//方向键盘是否可见，默认为true
            autoPosition : false,//是否自动定位，即地图初始化加载完成后，是否自动定位的用户所在地，在支持HTML5的浏览器中有效，默认为false

            /**
             *是否使用高德定位sdk用来辅助优化定位效果，默认：false.
             *仅供在使用了高德定位sdk的APP中，嵌入webview页面时使用
             *注：如果要使用辅助定位的功能，除了需要将useNative属性设置为true以外，
             *还需要调用高德定位idk中，AMapLocationClient类的startAssistantLocation()方法开启辅助H5定位功能；
             *不用时，可以调用stopAssistantLocation()方法停止辅助H5定位功能。具体用法可参考定位SDK的参考手册
             */
            useNative : false
        }
        var tool = new AMap.ToolBar(toolBaropt);
        map.addControl(tool);
    });
	
    //获取门店中心点
    function getStorePosition(){
   	  doManager("areaManager", "getStoreServiceAreaAndPosition", [storeId], function(
   				data, textStatus, XMLHttpRequest) {
   			if (data.result) {
   				var resultJson = JSON.parse(data.data);
   				if(resultJson.code == 200){
   					var position = resultJson.position;
   					
   					//初始化地图对象，加载地图
   					map.setCenter(position);
   					
   				}else{
   					layer.msg("暂时无法定位门店")
   				}
   			}
   		},false);
   }
    
    

    var arrayObj = new Array();//小区色块数组
	var areaColor = {};//小区色块
	var colorOther = "#0e0e0e";//灰色（超出20个片区的范围的）
	var colorArrar = new Array("#007979","#00FFFF","#796400","#FFD306","#009100","#5151A2","#8F4586","#F75000","#FF0000","#FF9797","#FF0080","#600000","#820041","#4B0091","#A8FF24","#63B8FF","#5E5E5E","#bf88113d","#0000FF","#7CCD7C");
    $(function(){
    	getStorePosition();
    	initData();
        $("#search").keyup(function(th){
            var searchStr = $("#search").val();
            $("span[id^='tinyvillage_']").each(function(i,t){
                var id =  $(t).attr("id");
                var tinyname = $(t).text();
                var idArr = id.split("_");

                if(tinyname.indexOf(searchStr)<0){
                    $("#"+idArr[1]).hide();
                }else{
                    $("#"+idArr[1]).show();
                }
            })
        });

        $(".result_hide").hover(function(){
            setNavListVisible(true);
        });

        $("#search").keyup();
        
        
        $("#search").keyup(function(th){
            var searchStr = $("#search").val();
            $("span[id^='tinyvillage_']").each(function(i,t){
                var id =  $(t).attr("id");
                var tinyname = $(t).text();
                var idArr = id.split("_");

                if(tinyname.indexOf(searchStr)<0){
                    $("#"+idArr[1]).hide();
                }else{
                    $("#"+idArr[1]).show();
                }
            })
        });
       
    })
    
    //查询片区所辖小区
    function initData(){
    	doManager("areaManager", "selectTinyVillageCoordOfArea",[storeId,areaNo], function(data, textStatus,XMLHttpRequest) {
            if(data.result){
            	
            	var resultJson= JSON.parse(data.data);
            	if(resultJson!=null){
            		var coordinate = resultJson.coordinate;//小区坐标
            		var storeService = resultJson.serviceArea;//服务范围
            		var  tinyVillage = resultJson.tinyVillage;//小区
            		
            		for(var i=0;i<tinyVillage.length;i++){
            			var areaHtml =  '<li id="'+tinyVillage[i].code+'" onmouseover="lightPloygon(\''+tinyVillage[i].code+'\')" onmouseout="showAllTinyArea(\''+tinyVillage[i].code+'\')">'+
			         				   		'<div class="col-lg-8 no-padding">'+
			 					   				'<a href="javascript:tv_record(\''+tinyVillage[i].code+'\')">'+
			         				   		    '<p><span>'+(i+1)+'</span> . <span id="tinyvillage_'+tinyVillage[i].code+'">'+tinyVillage[i].tinyvillageName+'</span></p>'+
			 					   				'</a>'+
			 				   				'</div>'+
			 			   				'</li>';
			 			   				
			 			 $("#tinyvillage_ul").append(areaHtml);
            		}
            	}
            	initTinyVillage(storeService,coordinate);//绘制地图
                createShade(storeService);  
                
            }else{
                $$.showMessage("系统信息", "数据加载异常！");
            }},false);
    }


    var googleLayer = null;
    //服务区域
    var  serviceRange;
    var polygonArray = [];
    
    function initTinyVillage(storeService,coordinate) {
        map.clearMap();
        //服务区域多边形
        serviceRange = new AMap.Polygon({
            path: storeService,//设置多边形边界路径
            strokeColor: "#F00", //线颜色
            strokeOpacity: 0.9, //线透明度
            strokeWeight: 2,    //线宽
            fillColor: "#00DD00", //填充色
            fillOpacity: 0//填充透明度
        });
        serviceRange.setMap(map);
        serviceRange.on("click", function () {
            setNavListVisible(false);
        });

        var areaTinyVillage;//小区坐标范围
        var tinyVillageMarker;
        var tinyVillagePolygon;
       
        for(var i=0;i<coordinate.length;i++){
               
                //绘制小区
            	areaTinyVillage = new AMap.Polygon({
                        path:coordinate[i].coordinate_range.coordinates[0],//设置多边形边界路径
                        strokeColor:"#FF33FF", //线颜色
                        strokeOpacity: 1.0, //线透明度
                        strokeWeight: 2,    //线宽
                        fillColor: "#1791fc", //填充色
                        fillOpacity: 0.45,//填充透明度
                        extData:{"tinyVillageNo":coordinate[i].code} 
                    });
                
                areaTinyVillage.setMap(map);
                var tmp_tinyVillageCoordinate={
	        			code:coordinate[i].code,
	        			tinyVillagePolygon:areaTinyVillage
	        	}  
                polygonArray.push(tmp_tinyVillageCoordinate);
            	areaTinyVillage.on("click",function(e){
                    var code= e.target.getExtData().tinyVillageNo;
					var url = "dynamicData_tinyvillage.html?e=&code="+encode64(code);
	   				window.open(url,"dynamicData_tinyvillage");
					
	        	});
               var $tinyVillageName = coordinate[i].name;  
               var strLength = -(($tinyVillageName.length*14+20)/2);
               var $position = coordinate[i].location; 
               if($position!=null&&$position.length==2){
            	   tinyVillageMarker = new AMap.Marker({ //对小区添加自定义点标记
            		    visible:false,
            		    map:map,
          		        position: areaTinyVillage.getBounds().getCenter(), //基点位置
          		        offset: new AMap.Pixel(strLength, -36), //相对于基点的偏移位置
          		       // draggable: true,  //是否可拖动
          		        content: '<div class="marker-route marker-marker-bus-from">'+$tinyVillageName+'</div>',   //自定义点标记覆盖物内容
          		        extData:{"tinyVillageNo":coordinate[i].code} 
            	   }); 
            	   
            	   areaTinyVillage.setExtData({"tinyVillageNo":coordinate[i].code, "marker": tinyVillageMarker});
            	   areaTinyVillage.on("mouseover", function (e) {
                           e.target.getExtData().marker.show();
                   });
            	   areaTinyVillage.on("mouseout", function (e) {
                       e.target.getExtData().marker.hide();
                   });
            	   tinyVillageMarker.on("click",function(e){
	   	        		var code= e.target.getExtData().tinyVillageNo;
						var url = "dynamicData_tinyvillage.html?e=&code="+encode64(code);
		   				window.open(url,"dynamicData_tinyvillage");
   	        	   });
               } 
        }
        
        $("#process_div").hide();
        $("#process_div_pic").hide();
        
    }
	
    //片区所辖小区高亮显示并显示小区
    var prve_areaNo;
	function lightPloygon(code_s){
		for(var i=0;i<polygonArray.length;i++){//片区管辖小区坐标高亮显示
			var code = polygonArray[i].code;
			if(code_s==code){
				polygonArray[i].tinyVillagePolygon.setOptions({
					strokeColor:"#ADFF2F",
					fillColor:"#ADFF2F"
				});
			}
		}
		
	}
	
	//鼠标离开恢复小区颜色
   function showAllTinyArea(code_s){
	   for(var i=0;i<polygonArray.length;i++){//片区管辖小区坐标高亮显示
			var code = polygonArray[i].code;
			if(code_s==code){
				polygonArray[i].tinyVillagePolygon.setOptions({
					strokeColor:"#FF33FF",
					fillColor:"#1791fc"
				});
			}
		}
   } 
	
	
	
   function cleanSearch(){
       $("#search").val("");
       $("#search").keyup();
   }
   
   
   
   //跳转到小区档案
   function tv_record(code){
	   var url = "dynamicData_tinyvillage.html?e=&code="+encode64(code);
	   window.open(url,"dynamicData_tinyvillage");
   }
</script>
</body>
</html>
